<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Mentos ‚Äì F√ºtterungstracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa&family=Rock+Salt&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Comfortaa', cursive;
      background: radial-gradient(circle at top left, #c7f9cc, #80ed99 40%, #57cc99 90%, #38a3a5);
    }
    h1, h2 { font-family: 'Rock Salt', cursive; }
    .kiffer-shadow { box-shadow: 0 15px 35px rgba(22, 163, 74, 0.4); }
    .glass-effect { backdrop-filter: blur(14px); background-color: rgba(255, 255, 255, 0.88); }
    .dark .glass-effect { background-color: rgba(31, 41, 55, 0.88); }
    input, select, textarea {
      background-color: white;
      color: black;
    }
    ::placeholder {
      color: #6b7280;
    }
    .dark input,
    .dark select,
    .dark textarea {
      background-color: #374151;
      color: white;
    }
    .dark ::placeholder { color: #9ca3af; }
  </style>
</head>
<body class="text-green-900 relative dark:bg-gray-900 dark:text-white">
  <div class="fixed top-4 right-4 z-50">
    <button onclick="toggleDarkMode()" class="bg-gray-300 dark:bg-gray-700 text-black dark:text-white px-4 py-2 rounded shadow">
      üåô / ‚òÄÔ∏è
    </button>
  </div>

  <div class="w-full px-3 py-2 max-w-screen-sm mx-auto mt-12 sm:mt-20 p-6 sm:p-10 rounded-3xl kiffer-shadow border-4 border-green-300 glass-effect animate-fade-in">
    <h1 class="text-3xl sm:text-4xl font-bold mb-6 text-center text-green-800">Mentos üê±</h1>
    <h2 class="text-xl text-center">Letzte F√ºtterung vor:</h2>
    <div id="last-feed" class="text-3xl sm:text-4xl font-mono text-center mb-4">-</div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mb-6">
      <button id="btn-nass" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow">üêü Nassfutter gegeben</button>
      <button id="btn-trocken" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-full shadow">ü•£ Trockenfutter gegeben</button>
    </div>

    <div id="admin-buttons" class="hidden flex flex-col sm:flex-row justify-center gap-4 mb-6">
        <button id="reset-timer-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow">‚è±Ô∏è Timer zur√ºcksetzen</button>
        <button id="clear-history-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow">üóëÔ∏è Anzeige l√∂schen</button>
    </div>
    <div class="overflow-x-auto">
      <table class="table-auto w-full text-center text-sm">
        <thead>
          <tr>
            <th class="px-2 py-1 border-b">Zeit</th>
            <th class="px-2 py-1 border-b">Futterart</th>
            <th class="px-2 py-1 border-b">Gef√ºttert von</th>
          </tr>
        </thead>
        <tbody id="feedings-body"></tbody>
      </table>
    </div>

    <div class="text-center mt-8">
      <a href="dashboard.html" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full shadow">
        ‚¨ÖÔ∏è Zur√ºck zum Dashboard
      </a>
    </div>
  </div>

  <script>
    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark ? 'true' : 'false');
    }
    if (localStorage.getItem('darkMode') === 'true') {
      document.documentElement.classList.add('dark');
    }

    const supabase = window.supabase.createClient(
      "https://izkuiqjhzeeirmcikbef.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VpcWpoemVlaXJtY2lrYmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MDAwOTQsImV4cCI6MjA2NDM3NjA5NH0.mPu0jQYnt0uGoLgehNFDHZprEcmrzGJ667D31sLSbj0"
    );

    let countdownInterval;

    const adminButtons = document.getElementById('admin-buttons');
    const resetTimerBtn = document.getElementById('reset-timer-btn');
    const clearHistoryBtn = document.getElementById('clear-history-btn');

    supabase.auth.getUser().then(async ({ data }) => {
      if (!data?.user) return;
      const { data: profile } = await supabase
        .from('users')
        .select('role')
        .eq('id', data.user.id)
        .single();
      if (profile?.role === 'admin') {
        adminButtons.classList.remove('hidden');
      }
    });

    async function loadFeedings() {
      const { data, error } = await supabase
        .from('mentos_feedings')
        .select('zeitstempel,futterart,gefuettert_von')
        .order('zeitstempel', { ascending: false })
        .limit(20);
      if (error) return;
      updateTable(data);
      if (data.length) startCountdown(new Date(data[0].zeitstempel));
    }

    function updateTable(entries) {
      const body = document.getElementById('feedings-body');
      body.innerHTML = entries.map(e => `
        <tr>
          <td class="px-2 py-1 border-b">${new Date(e.zeitstempel).toLocaleString()}</td>
          <td class="px-2 py-1 border-b">${e.futterart}</td>
          <td class="px-2 py-1 border-b">${e.gefuettert_von || ''}</td>
        </tr>`).join('');
    }

    function startCountdown(time) {
      clearInterval(countdownInterval);
      function update() {
        const diff = Date.now() - time.getTime();
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const display = document.getElementById('last-feed');
        display.textContent = `${hours}h ${minutes}m`;
        display.classList.remove('text-green-600', 'text-orange-600', 'text-red-600');
        if (hours < 4) display.classList.add('text-green-600');
        else if (hours < 8) display.classList.add('text-orange-600');
        else display.classList.add('text-red-600');
      }
      update();
      countdownInterval = setInterval(update, 60000);
    }

    async function addFeeding(type) {
      const { data: auth } = await supabase.auth.getUser();
      const name = auth?.user ? (auth.user.user_metadata?.name || auth.user.email.split('@')[0]) : null;
      await supabase.from('mentos_feedings').insert({ futterart: type, gefuettert_von: name });
      loadFeedings();
    }

    document.getElementById('btn-nass').addEventListener('click', () => addFeeding('Nassfutter'));
    document.getElementById('btn-trocken').addEventListener('click', () => addFeeding('Trockenfutter'));

      function resetTimerDisplay() {
        clearInterval(countdownInterval);
        const display = document.getElementById('last-feed');
        display.textContent = '-';
        display.classList.remove('text-green-600', 'text-orange-600', 'text-red-600');
      }

    async function clearFeedingHistory() {
      await supabase
        .from('mentos_feedings')
        .delete()
        .gt('zeitstempel', '1900-01-01');
      resetTimerDisplay();
      loadFeedings();
    }

    resetTimerBtn.addEventListener('click', resetTimerDisplay);
    clearHistoryBtn.addEventListener('click', clearFeedingHistory);

    loadFeedings();
  </script>
</body>
</html>
