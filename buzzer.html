<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buzzer</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #d1fae5, #a7f3d0, #6ee7b7);
      margin: 0;
      padding: 40px;
    }
    #buzz-btn {
      font-size: 2rem;
      padding: 1.5rem 3rem;
      background: #facc15;
      color: #fff;
      border: none;
      border-radius: 9999px;
      cursor: pointer;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 12px;
    }
    #admin-form {
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <button id="buzz-btn">ðŸ””</button>
  <audio id="buzz-sound" src="buzz.wav" preload="auto"></audio>

  <div id="round-info" style="margin-top:20px;font-weight:bold;">Keine aktive Runde</div>

  <div id="join-section" style="margin-top:20px;"></div>

  <div id="admin-section" style="margin-top:30px;display:none;">
    <button id="show-form-btn">Runde starten</button>
    <div id="admin-form" style="display:none;">
      <input type="number" id="bet-input" placeholder="Einsatz" step="0.01">
      <input type="number" id="limit-input" placeholder="Punktelimit">
      <button id="start-round-btn">Starten</button>
    </div>
  </div>

  <script>
  const SUPABASE_URL = "https://izkuiqjhzeeirmcikbef.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VpcWpoemVlaXJtY2lrYmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MDAwOTQsImV4cCI6MjA2NDM3NjA5NH0.mPu0jQYnt0uGoLgehNFDHZprEcmrzGJ667D31sLSbj0";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;
  let currentRound = null;

  document.getElementById('buzz-btn').addEventListener('click', () => {
    document.getElementById('buzz-sound').play();
  });

  document.getElementById('show-form-btn').addEventListener('click', () => {
    const form = document.getElementById('admin-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  });

  document.getElementById('start-round-btn').addEventListener('click', startRound);

  document.addEventListener('DOMContentLoaded', async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      window.location.href = 'index.html';
      return;
    }
    currentUser = user;
    await checkAdmin();
    await loadRound();
    setInterval(loadRound, 5000);
  });

  async function checkAdmin() {
    const { data } = await supabase
      .from('users')
      .select('role')
      .eq('id', currentUser.id)
      .single();
    if (data && data.role === 'admin') {
      document.getElementById('admin-section').style.display = 'block';
    }
  }

  async function loadRound() {
    const { data: round } = await supabase
      .from('buzzer_rounds')
      .select('*')
      .eq('active', true)
      .single();
    if (!round) {
      currentRound = null;
      document.getElementById('round-info').textContent = 'Keine aktive Runde';
      document.getElementById('join-section').innerHTML = '';
      return;
    }
    currentRound = round;
    document.getElementById('round-info').textContent =
      `Einsatz: ${parseFloat(round.bet).toLocaleString('de-DE', {minimumFractionDigits:2})}â€¯â‚¬ | Punktelimit: ${round.points_limit}`;
    await renderJoinOrTable();
  }

  async function renderJoinOrTable() {
    const { data: participant } = await supabase
      .from('buzzer_participants')
      .select('id')
      .eq('user_id', currentUser.id)
      .eq('round_id', currentRound.id)
      .maybeSingle();

    if (!participant) {
      document.getElementById('join-section').innerHTML =
        '<button id="join-btn">Runde beitreten</button>';
      document.getElementById('join-btn').onclick = joinRound;
    } else {
      await renderParticipantTable();
    }
  }

  async function renderParticipantTable() {
    const { data: participants } = await supabase
      .from('buzzer_participants')
      .select('username,user_id')
      .eq('round_id', currentRound.id);

    const { data: scores } = await supabase
      .from('scores')
      .select('user_id,points')
      .eq('round_id', currentRound.id);

    let html = '<table><tr><th>Name</th><th>Punkte</th></tr>';
    (participants || []).forEach(p => {
      const s = (scores || []).find(sc => sc.user_id === p.user_id);
      const pts = s ? s.points : 0;
      html += `<tr><td>${p.username}</td><td>${pts}</td></tr>`;
    });
    html += '</table>';
    document.getElementById('join-section').innerHTML = html;
  }

  async function joinRound() {
    if (!currentRound) return;
    const username = currentUser.email.split('@')[0];
    await supabase.from('buzzer_participants').insert({
      user_id: currentUser.id,
      username,
      round_id: currentRound.id
    });
    await renderParticipantTable();
  }

  async function startRound() {
    const bet = parseFloat(document.getElementById('bet-input').value);
    const limit = parseInt(document.getElementById('limit-input').value, 10);
    if (isNaN(bet) || isNaN(limit)) return;

    await supabase
      .from('buzzer_rounds')
      .update({ active: false })
      .eq('active', true);
    await supabase.from('buzzer_rounds').insert({
      bet: bet,
      points_limit: limit,
      active: true,
      start_time: new Date().toISOString()
    });
    document.getElementById('admin-form').style.display = 'none';
    await loadRound();
  }
  </script>
</body>
</html>
