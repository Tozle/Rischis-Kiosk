<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Buzzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="flex flex-col items-center justify-center h-screen bg-green-100 text-green-900 font-sans space-y-6">
  <h1 class="text-3xl font-bold">ðŸ”” Buzzer</h1>
  <audio id="buzz-sound" src="buzz.wav" preload="auto"></audio>
  <p id="status" class="text-xl font-semibold"></p>
  <button id="buzzer-btn" class="text-4xl px-12 py-10 bg-green-600 text-white rounded-full shadow-xl hover:bg-green-700 disabled:opacity-50 transition-all duration-300">ðŸš¨ BUZZERN</button>  <button id="reset-btn" class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 hidden">Reset (Admin)</button>

  <script>
    window.supabase = supabase.createClient(
      'https://izkuiqjhzeeirmcikbef.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VpcWpoemVlaXJtY2lrYmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MDAwOTQsImV4cCI6MjA2NDM3NjA5NH0.mPu0jQYnt0uGoLgehNFDHZprEcmrzGJ667D31sLSbj0'
    );

    const buzzerBtn = document.getElementById("buzzer-btn");
    const resetBtn = document.getElementById("reset-btn");
    const status = document.getElementById("status");

    let currentUser = null;

    async function checkUser() {
      const { data: auth, error } = await supabase.auth.getUser();
      if (error || !auth?.user) {
        console.error("Auth Fehler:", error);
        return location.href = "index.html";
      }
      currentUser = auth.user;

      const { data: profile, error: errProfile } = await supabase
        .from("users")
        .select("role, name")
        .eq("id", currentUser.id)
        .single();

      if (errProfile) {
        console.error("Profil-Fehler:", errProfile);
        return;
      }

      if (profile?.role === 'admin') {
        resetBtn.classList.remove("hidden");
      }

      currentUser.name = profile.name;
    }

    async function getActiveBuzz() {
      const { data, error } = await supabase
        .from("buzzer_state")
        .select("*")
        .eq("active", true)
        .order("timestamp", { ascending: true })
        .limit(1)
        .single();

      if (error) {
        console.warn("getActiveBuzz Error:", error.message);
        return null;
      }

      return data;
    }

    async function refreshStatus() {
      const buzz = await getActiveBuzz();
      if (buzz) {
        status.textContent = `${buzz.username} hat gebuzzert!`;
        buzzerBtn.disabled = true;
      } else {
        status.textContent = "Niemand hat bisher gebuzzert.";
        buzzerBtn.disabled = false;
      }
    }

    buzzerBtn.addEventListener("click", async () => {
  const existing = await getActiveBuzz();
  if (existing) {
    console.log("Schon jemand gebuzzert:", existing.username);
    return;
  }

  if (!currentUser || !currentUser.name) {
    alert("Nutzer nicht geladen.");
    return;
  }

  const insertObj = {
    user_id: currentUser.id,
    username: currentUser.name,
    timestamp: new Date().toISOString(),
    active: true
  };

  const { error } = await supabase.from("buzzer_state").insert(insertObj);
  if (error) {
    console.error("Insert Error:", error.message);
    alert("Fehler beim Buzzern.");
  }

  // ðŸ”Š Buzzer-Sound abspielen
  document.getElementById("buzz-sound").play();

  refreshStatus();
});


    resetBtn.addEventListener("click", async () => {
      if (!currentUser?.id) return alert("Kein Nutzer geladen!");

      const { data: profile, error: profileError } = await supabase
        .from("users")
        .select("role")
        .eq("id", currentUser.id)
        .single();

      if (profileError || profile?.role !== 'admin') {
        return alert("Keine Admin-Berechtigung!");
      }

const { error: deleteError } = await supabase
  .from("buzzer_state")
  .delete()
  .gt("timestamp", "1900-01-01");


      if (deleteError) {
        console.error("Fehler beim ZurÃ¼cksetzen:", deleteError.message);
        alert("ZurÃ¼cksetzen fehlgeschlagen!");
      } else {
        alert("Buzzer zurÃ¼ckgesetzt!");
        refreshStatus();
      }
    });

    supabase
      .channel('buzzer-updates')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'buzzer_state' }, () => {
        console.log("Realtime-Update erhalten");
        refreshStatus();
      })
      .subscribe();

    checkUser().then(refreshStatus);
  </script>
</body>
</html>
