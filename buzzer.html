<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buzzer Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Comfortaa', cursive;
      background: radial-gradient(circle at top left, #c7f9cc, #80ed99 40%, #57cc99 90%, #38a3a5);
      animation: background-float 24s ease-in-out infinite;
    }
    @keyframes background-float {
      0%, 100% { background-position: 0% 0%; }
      50% { background-position: 100% 100%; }
    }
    .kiffer-shadow { box-shadow: 0 15px 35px rgba(22, 163, 74, 0.4); }
    .glass-effect { backdrop-filter: blur(14px); background-color: rgba(255, 255, 255, 0.88); }
    .dark .glass-effect { background-color: rgba(31, 41, 55, 0.88); }
    input, select, textarea { background-color: white; color: black; }
    ::placeholder { color: #6b7280; }
    .dark input, .dark select, .dark textarea { background-color: #374151; color: white; }
    .dark ::placeholder { color: #9ca3af; }
  </style>
</head>
<body class="text-green-900 relative dark:bg-gray-900 dark:text-white">
  <div class="fixed bottom-4 right-4 z-50">
    <button onclick="toggleDarkMode()" class="bg-gray-300/75 dark:bg-gray-700/75 text-black dark:text-white p-2 rounded-full shadow opacity-70 hover:opacity-100 transition">üåô</button>
  </div>
  <div class="fixed top-4 left-4 z-50">
    <a href="dashboard.html" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-full shadow text-sm">‚¨ÖÔ∏è Zur√ºck</a>
  </div>
  <div class="w-full px-3 py-2 max-w-screen-sm mx-auto mt-12 sm:mt-20 p-6 sm:p-10 rounded-3xl kiffer-shadow border-4 border-green-300 glass-effect">
    <h1 class="text-3xl sm:text-4xl font-bold mb-6 text-center">üéµ Buzzer Spiel</h1>
    <p id="online-users" class="text-sm mb-4">Online: </p>
    <div id="participants" class="mb-4 space-y-1 text-sm"></div>
    <p id="buzz-info" class="text-lg font-semibold mb-4"></p>
    <button id="buzzer-btn" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-full shadow-lg mb-6">Buzz!</button>
    <div id="admin-controls" class="hidden">
      <button id="start-round-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow">Runde starten</button>
      <div id="round-form" class="hidden mt-4 space-y-2">
        <select id="bet-select" class="border rounded p-2 w-full"></select>
        <select id="limit-select" class="border rounded p-2 w-full"></select>
        <button id="create-round" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full">Starten</button>
      </div>
      <div id="award-controls" class="hidden mt-4 space-x-2">
        <button id="give-point" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">Punkt vergeben</button>
        <button id="no-point" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded">Nichts tun</button>
      </div>
    </div>
  </div>
  <div id="round-popup" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl text-center space-y-4 max-w-sm mx-auto">
      <p id="popup-text"></p>
      <button id="confirm-popup" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Verstanden</button>
    </div>
  </div>
<script>
  function toggleDarkMode() {
    const isDark = document.documentElement.classList.toggle('dark');
    localStorage.setItem('darkMode', isDark ? 'true' : 'false');
  }
  if (localStorage.getItem('darkMode') !== 'false') document.documentElement.classList.add('dark');

  const supabase = window.supabase.createClient(
    "https://izkuiqjhzeeirmcikbef.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VpcWpoemVlaXJtY2lrYmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MDAwOTQsImV4cCI6MjA2NDM3NjA5NH0.mPu0jQYnt0uGoLgehNFDHZprEcmrzGJ667D31sLSbj0"
  );

  let currentUser = null;
  let currentRole = null;
  let activeRound = null;
  let participantEntry = null;
  let buzzedParticipant = null;

  async function init() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return window.location.href = 'index.html';
    currentUser = user;
    const { data: profile } = await supabase.from('users').select('role,balance').eq('id', user.id).single();
    currentRole = profile?.role;
    checkAdmin();
    loadRound();
    loadOnlineUsers();
    subscribeToSessions();
    subscribeToRounds();
  }

  function checkAdmin() {
    if (currentRole === 'admin') {
      document.getElementById('admin-controls').classList.remove('hidden');
    } else {
      document.getElementById('buzzer-btn').classList.remove('hidden');
    }
  }

  async function loadOnlineUsers() {
    const { data } = await supabase.from('user_sessions').select('username').eq('online', true);
    const names = data?.map(u => u.username).join(', ') || '';
    document.getElementById('online-users').textContent = 'Online: ' + names;
  }

  function subscribeToSessions() {
    supabase.channel('sessions').on('postgres_changes', { event: '*', schema: 'public', table: 'user_sessions' }, loadOnlineUsers).subscribe();
  }

  async function loadRound() {
    const { data } = await supabase.from('buzzer_rounds').select('*').eq('active', true).order('start_time', { ascending: false }).limit(1).single();
    if (data) {
      activeRound = data;
      await handleRound();
    }
  }

  function subscribeToRounds() {
    supabase.channel('rounds').on('postgres_changes', { event: '*', schema: 'public', table: 'buzzer_rounds' }, payload => {
      if (payload.new.active) {
        activeRound = payload.new;
        handleRound();
      } else if (activeRound && payload.old.id === activeRound.id && !payload.new.active) {
        activeRound = null;
        participantEntry = null;
        document.getElementById('buzz-info').textContent = '';
        document.getElementById('buzzer-btn').disabled = false;
      }
    }).subscribe();

    supabase.channel('participants').on('postgres_changes', { event: '*', schema: 'public', table: 'buzzer_participants' }, handleParticipantsChange).subscribe();
  }

  async function handleRound() {
    if (!activeRound) return;
    populateRoundForm();
    updateParticipants();
    if (currentRole !== 'admin') checkPopup();
  }

  function populateRoundForm() {
    const betSelect = document.getElementById('bet-select');
    const limitSelect = document.getElementById('limit-select');
    if (betSelect.childElementCount === 0) {
      for (let i = 0.25; i <= 2; i += 0.25) {
        const opt = document.createElement('option');
        opt.value = i.toFixed(2);
        opt.textContent = opt.value + ' ‚Ç¨ Einsatz';
        betSelect.appendChild(opt);
      }
      for (let p = 1; p <= 10; p++) {
        const opt2 = document.createElement('option');
        opt2.value = p;
        opt2.textContent = p + ' Punkte';
        limitSelect.appendChild(opt2);
      }
    }
  }

  async function startRound() {
    document.getElementById('round-form').classList.toggle('hidden');
  }

  async function createRound() {
    const bet = parseFloat(document.getElementById('bet-select').value);
    const limit = parseInt(document.getElementById('limit-select').value);
    const { data, error } = await supabase.from('buzzer_rounds').insert({ bet, points_limit: limit, start_time: new Date().toISOString(), active: true }).select('*').single();
    if (!error) {
      activeRound = data;
      document.getElementById('round-form').classList.add('hidden');
    }
  }

  async function checkPopup() {
    if (!activeRound) return;
    const key = 'roundConfirmed_' + activeRound.id;
    const confirmedLocal = localStorage.getItem(key);
    const { data: meta } = await supabase.from('buzzer_user_round_meta').select('confirmed_popup').eq('round_id', activeRound.id).eq('user_id', currentUser.id).single();
    if (confirmedLocal || meta?.confirmed_popup) {
      joinRound();
      return;
    }
    const text = `Neue Runde! Einsatz: ${activeRound.bet.toFixed(2)} ‚Ç¨ ‚Äì Ziel: ${activeRound.points_limit} Punkte`;
    document.getElementById('popup-text').textContent = text;
    document.getElementById('round-popup').classList.remove('hidden');
  }

  async function confirmPopup() {
    const key = 'roundConfirmed_' + activeRound.id;
    await supabase.from('buzzer_user_round_meta').upsert({ user_id: currentUser.id, round_id: activeRound.id, confirmed_popup: true });
    localStorage.setItem(key, 'true');
    document.getElementById('round-popup').classList.add('hidden');
    await joinRound();
  }

  async function joinRound() {
    if (!activeRound) return;
    const { data: participants } = await supabase.from('buzzer_participants').select('*').eq('round_id', activeRound.id).eq('user_id', currentUser.id);
    if (!participants || participants.length === 0) {
      const { data: user } = await supabase.from('users').select('balance,email').eq('id', currentUser.id).single();
      if (user.balance <= -10) return alert('Dein Guthaben ist zu niedrig.');
      await supabase.from('buzzer_participants').insert({ round_id: activeRound.id, user_id: currentUser.id, username: currentUser.email.split('@')[0], has_buzzed: false, confirmed_popup: true });
      await supabase.from('users').update({ balance: user.balance - activeRound.bet }).eq('id', currentUser.id);
    }
    participantEntry = await supabase.from('buzzer_participants').select('*').eq('round_id', activeRound.id).eq('user_id', currentUser.id).single().then(r => r.data);
    document.getElementById('buzzer-btn').classList.remove('hidden');
  }

  async function updateParticipants() {
    if (!activeRound) return;
    const { data } = await supabase.from('buzzer_participants').select('user_id,username,has_buzzed').eq('round_id', activeRound.id);
    const { data: scores } = await supabase.from('scores').select('user_id,points').eq('game_type','buzzer').in('user_id', data.map(p=>p.user_id));
    const scoreMap = {};
    scores?.forEach(s => { scoreMap[s.user_id] = s.points; });
    const list = document.getElementById('participants');
    list.innerHTML = '';
    data?.forEach(p => {
      const li = document.createElement('div');
      li.textContent = `${p.username} ‚Äì ${scoreMap[p.user_id] || 0} Punkte${p.has_buzzed ? ' (gebuzzert)' : ''}`;
      list.appendChild(li);
      if (p.has_buzzed) buzzedParticipant = p;
    });
    if (buzzedParticipant) {
      document.getElementById('buzz-info').textContent = `${buzzedParticipant.username} hat gebuzzert!`;
      if (currentRole === 'admin') document.getElementById('award-controls').classList.remove('hidden');
      document.getElementById('buzzer-btn').disabled = true;
    } else {
      document.getElementById('buzz-info').textContent = '';
      document.getElementById('award-controls').classList.add('hidden');
      if (participantEntry) document.getElementById('buzzer-btn').disabled = false;
    }
  }

  function handleParticipantsChange(payload) {
    if (activeRound && payload.new.round_id === activeRound.id) {
      updateParticipants();
    }
  }

  async function buzz() {
    if (!activeRound || !participantEntry) return;
    await supabase.from('buzzer_participants').update({ has_buzzed: true, buzz_time: new Date().toISOString() }).eq('id', participantEntry.id);
  }

  async function givePoint() {
    if (!buzzedParticipant) return;
    const { data: existing } = await supabase.from('scores').select('id,points').eq('user_id', buzzedParticipant.user_id).eq('game_type','buzzer').single();
    if (existing) {
      await supabase.from('scores').update({ points: existing.points + 1 }).eq('id', existing.id);
    } else {
      await supabase.from('scores').insert({ user_id: buzzedParticipant.user_id, username: buzzedParticipant.username, points: 1, game_type: 'buzzer' });
    }
    await resetBuzz();
    checkWin(buzzedParticipant.user_id);
  }

  async function checkWin(uid) {
    const { data: score } = await supabase.from('scores').select('points').eq('user_id', uid).eq('game_type','buzzer').single();
    if (score && activeRound && score.points >= activeRound.points_limit) {
      await supabase.from('buzzer_rounds').update({ active: false, winner_id: uid }).eq('id', activeRound.id);
      const { count } = await supabase.from('buzzer_participants').select('*', { count: 'exact', head: true }).eq('round_id', activeRound.id);
      const pot = (count || 0) * activeRound.bet;
      const { data: bal } = await supabase.from('users').select('balance').eq('id', uid).single();
      await supabase.from('users').update({ balance: bal.balance + pot }).eq('id', uid);
      alert(`Runde beendet! ${buzzedParticipant.username} gewinnt ${pot.toFixed(2)} ‚Ç¨`);
    }
  }

  async function resetBuzz() {
    if (!activeRound) return;
    await supabase.from('buzzer_participants').update({ has_buzzed: false, buzz_time: null }).eq('round_id', activeRound.id);
    buzzedParticipant = null;
  }

  document.getElementById('buzzer-btn').addEventListener('click', buzz);
  document.getElementById('start-round-btn').addEventListener('click', startRound);
  document.getElementById('create-round').addEventListener('click', createRound);
  document.getElementById('confirm-popup').addEventListener('click', confirmPopup);
  document.getElementById('give-point').addEventListener('click', givePoint);
  document.getElementById('no-point').addEventListener('click', resetBuzz);

  init();
</script>
</body>
</html>
