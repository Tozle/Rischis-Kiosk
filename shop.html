<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Rischis Kiosk">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#38a3a5">
  <title>Rischis Kiosk ‚Äì Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa&family=Rock+Salt&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Comfortaa', cursive;
      background: radial-gradient(circle at top left, #c7f9cc, #80ed99 40%, #57cc99 90%, #38a3a5);
      animation: background-float 24s ease-in-out infinite;
    }
    h1, h2 {
      font-family: 'Rock Salt', cursive;
    }
    @keyframes background-float {
      0%, 100% { background-position: 0% 0%; }
      50% { background-position: 100% 100%; }
    }
    .panel-shadow {
      box-shadow: 0 15px 35px rgba(22, 163, 74, 0.4);
    }
    .glass-effect {
      backdrop-filter: blur(14px);
      background-color: rgba(255, 255, 255, 0.88);
    }
  body {
    max-width: 100vw;
    overflow-x: hidden;
    padding-top: env(safe-area-inset-top);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
  }

  .shop-container {
    box-sizing: border-box;
  }

  @media (max-width: 480px) {
    .shop-container {
      padding: 1rem !important;
      margin-top: 4rem !important;
    }

    h1 {
      font-size: 1.75rem;
    }

    h2 {
      font-size: 1.25rem;
    }
  }
  .dark .glass-effect {
    background-color: rgba(31, 41, 55, 0.88);
  }
  input, select, textarea {
    background-color: white;
    color: black;
  }
  ::placeholder {
    color: #6b7280;
  }
  .dark input,
  .dark select,
  .dark textarea {
    background-color: #374151;
    color: white;
  }
  .dark ::placeholder {
    color: #9ca3af;
  }
  </style>
</head>
<body class="text-green-900 relative dark:bg-gray-900 dark:text-white">
  <div class="fixed bottom-4 right-4 z-50">
    <button onclick="toggleDarkMode()" class="bg-gray-300/75 dark:bg-gray-700/75 text-black dark:text-white p-2 rounded-full shadow opacity-70 hover:opacity-100 transition">
      üåô
    </button>
  </div>
  <div class="fixed top-4 left-4 z-50">
    <a href="dashboard.html" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-full shadow text-sm">
      ‚¨ÖÔ∏è Zur√ºck zum Dashboard
    </a>
  </div>
  <div class="shop-container w-full px-3 py-2 max-w-screen-sm mx-auto mt-12 sm:mt-20 p-6 sm:p-10 rounded-3xl panel-shadow border-4 border-green-300 glass-effect animate-fade-in">

    <div id="loader" class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center hidden z-50 dark:bg-gray-900 dark:bg-opacity-70">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-green-500"></div>
    </div>

    <h1 class="text-3xl sm:text-4xl font-bold mb-8 text-center text-green-800">Rischis Kiosk</h1>
<label class="block mb-2 font-medium text-green-800">Kategorie ausw√§hlen:</label>
<select id="category-filter" class="mb-6 border-2 rounded-xl p-3 w-full border-green-400 bg-green-50 text-green-900 text-base">
  <option value="">Alle Kategorien</option>
</select>

<input type="text" id="search" placeholder="Produkt suchen..." class="mb-6 p-3 border-2 rounded-xl border-green-400 bg-green-50 placeholder-green-700 w-full text-base">

    <label class="block mb-2 font-medium text-green-800">Produkte sortieren:</label>
    <select id="sort-products" class="mb-6 border-2 rounded-xl p-3 w-full border-green-400 bg-green-50 text-green-900 text-base">
      <option value="name_asc">Name A-Z</option>
      <option value="name_desc">Name Z-A</option>
      <option value="price_asc">Preis aufsteigend</option>
      <option value="price_desc">Preis absteigend</option>
    </select>


    <div class="mb-6">
      <p><strong>Angemeldet als:</strong> <span id="user-email"></span></p>
      <p><strong>Guthaben:</strong> <span id="user-balance" class="font-bold">0.00 ‚Ç¨</span></p>
    </div>

    <div class="mt-8">
      <h2 class="text-lg sm:text-xl font-bold tracking-wide text-green-800 uppercase mb-4">Verf√ºgbare Produkte</h2>
      <ul id="product-list" class="overflow-x-auto block space-y-4"></ul>
    </div>

    <p id="message" class="mt-4 text-sm italic"></p>

    <div class="mt-12">
      <h2 class="text-lg sm:text-xl font-bold tracking-wide text-green-800 uppercase mb-4">Kaufverlauf</h2>
      <label class="block mb-2 font-medium text-green-800">Kaufverlauf sortieren:</label>
      <select id="sort-history" class="mb-6 border-2 rounded-xl p-3 w-full border-green-400 bg-green-50 text-green-900 text-base">
        <option value="desc">Neuste zuerst</option>
        <option value="asc">√Ñlteste zuerst</option>
        <option value="price_desc">Preis absteigend</option>
        <option value="price_asc">Preis aufsteigend</option>
      </select>
      <ul id="purchase-history" class="overflow-x-auto block space-y-2 text-sm"></ul>
    </div>
  </div>

  <script>
    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark ? 'true' : 'false');
    }
    // Darkmode bleibt aktiv, solange der Nutzer ihn nicht deaktiviert
    if (localStorage.getItem('darkMode') !== 'false') {
      document.documentElement.classList.add('dark');
    }

    const supabase = window.supabase.createClient(
      "https://izkuiqjhzeeirmcikbef.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6a3VpcWpoemVlaXJtY2lrYmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MDAwOTQsImV4cCI6MjA2NDM3NjA5NH0.mPu0jQYnt0uGoLgehNFDHZprEcmrzGJ667D31sLSbj0"
    );

    let currentUser = null;
    let userBalance = 0;

    function showMessage(text, type = 'info') {
      const el = document.getElementById('message');
      el.textContent = text;
      el.className = type === 'error' ? 'text-red-600' : 'text-green-600';
      setTimeout(() => { el.textContent = ''; }, 4000);
    }

async function loadCategories() {
  const { data: products, error } = await supabase
    .from('products')
    .select('category')
    .neq('category', null);

  if (error) return showMessage("Fehler beim Laden der Kategorien.", 'error');

  const uniqueCategories = [...new Set(products.map(p => p.category))];
  const select = document.getElementById('category-filter');
  uniqueCategories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    select.appendChild(opt);
  });
}


    function showLoader() {
      document.getElementById('loader').classList.remove('hidden');
    }

    function hideLoader() {
      document.getElementById('loader').classList.add('hidden');
    }

    async function loadUserData() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) return showMessage("Fehler beim Laden des Nutzers.", 'error');
      currentUser = user;
      document.getElementById('user-email').textContent = user.email;

      const { data, error: balanceError } = await supabase.from('users').select('balance').eq('id', user.id).single();
      if (balanceError) return showMessage("Fehler beim Laden des Guthabens.", 'error');
      userBalance = data.balance;

      const balanceElement = document.getElementById('user-balance');
      balanceElement.textContent = `${userBalance.toFixed(2)} ‚Ç¨`;
      balanceElement.className = userBalance < 0 ? 'text-red-600 font-bold' : 'text-green-900';
    }

    async function loadProducts() {
  showLoader();
  const searchTerm = document.getElementById('search')?.value?.toLowerCase() || '';
  const selectedCategory = document.getElementById('category-filter')?.value || '';
  const sortOption = document.getElementById('sort-products')?.value || 'name_asc';

  let query = supabase.from('products').select('*').eq('available', true);
  if (selectedCategory) {
    query = query.eq('category', selectedCategory);
  }

  if (sortOption === 'price_asc') {
    query = query.order('price', { ascending: true });
  } else if (sortOption === 'price_desc') {
    query = query.order('price', { ascending: false });
  } else if (sortOption === 'name_desc') {
    query = query.order('name', { ascending: false });
  } else {
    query = query.order('name', { ascending: true });
  }

  const { data: products, error } = await query;
  const list = document.getElementById('product-list');
  list.innerHTML = '';
  hideLoader();

  if (error || !products) {
    return showMessage("Fehler beim Laden der Produkte.", 'error');
  }

  products
  .filter(p => p.name.toLowerCase().includes(searchTerm))
  .forEach(product => {
    const li = document.createElement('li');
    li.className = 'border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 p-3 rounded-lg shadow-md hover:shadow-lg transition text-gray-800 dark:text-white';

    li.innerHTML = `
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div>
          <p class="text-sm sm:text-base font-semibold">${product.name}</p>
          <p class="text-xs sm:text-sm">${product.price.toFixed(2)} ‚Ç¨ ‚Äì Bestand: ${product.stock}
            ${product.stock <= 0 ? '<span class="text-red-600 ml-2">(ausverkauft)</span>' : ''}
          </p>
        </div>
        ${product.stock > 0 ?
          `<div class="flex items-center gap-2">
            <input type="number" min="1" max="${product.stock}" value="1" id="qty-${product.id}" class="w-14 border border-gray-300 rounded px-2 py-1 text-sm dark:bg-gray-700 dark:text-white dark:border-gray-600">
            <button class="bg-green-600 text-white text-sm px-3 py-1 rounded-md shadow hover:bg-green-700 transition" onclick="buyProduct('${product.id}', 'qty-${product.id}', '${product.name}', ${product.price})">Kaufen</button>
          </div>` : ''
        }
      </div>
    `;
    list.appendChild(li);
  });
}


    async function buyProduct(productId, qtyInputId, productName, unitPrice) {
      try {
        const qty = parseInt(document.getElementById(qtyInputId)?.value || "1");
        if (!Number.isInteger(qty) || qty <= 0) return showMessage("Ung√ºltige Menge", "error");

        const confirmText = `M√∂chtest du wirklich ${qty}x ${productName} f√ºr ${(unitPrice * qty).toFixed(2)} ‚Ç¨ kaufen?`;
        if (!confirm(confirmText)) return;

        const { data: userCheck } = await supabase.auth.getUser();
        if (!userCheck?.user) return alert("Nicht eingeloggt");

        const { data: dbUser } = await supabase.from('users').select('*').eq('id', userCheck.user.id).single();
        const { data: product } = await supabase.from('products').select('*').eq('id', productId).single();

        if (!product || product.stock < qty) return showMessage("Nicht gen√ºgend Bestand.", 'error');

        const newBalance = dbUser.balance - (unitPrice * qty);

        const { error: purchaseError } = await supabase.from('purchases').insert({
          user_id: dbUser.id,
          user_name: dbUser.name,
          product_id: productId,
          product_name: product.name,
          price: unitPrice * qty,
          quantity: qty
        });

        const { error: balanceError } = await supabase.from('users')
          .update({ balance: newBalance })
          .eq('id', dbUser.id);

        const { error: stockError } = await supabase.from('products')
          .update({ stock: product.stock - qty })
          .eq('id', product.id);

        if (purchaseError || balanceError || stockError) throw new Error("Fehler beim Kaufprozess");

        userBalance = newBalance;
        document.getElementById('user-balance').textContent = userBalance.toFixed(2);
        showMessage("Kauf erfolgreich!", 'success');
        await loadProducts();
        await loadPurchaseHistory();
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Kauf.", 'error');
      }
    }

    async function loadPurchaseHistory() {
      if (!currentUser?.id) return;

      const sortOption = document.getElementById('sort-history')?.value || 'desc';
      let query = supabase.from('purchases')
        .select('price, quantity, created_at, product_name')
        .eq('user_id', currentUser.id);

      if (sortOption === 'asc') {
        query = query.order('created_at', { ascending: true });
      } else if (sortOption === 'desc') {
        query = query.order('created_at', { ascending: false });
      } else if (sortOption === 'price_asc') {
        query = query.order('price', { ascending: true });
      } else if (sortOption === 'price_desc') {
        query = query.order('price', { ascending: false });
      }

      const { data: history, error } = await query;
      if (error || !history) return;

      const sorted = history;

      const list = document.getElementById('purchase-history');
      list.innerHTML = '';
      sorted.forEach(entry => {
        const li = document.createElement('li');
        const date = new Date(entry.created_at).toLocaleString('de-DE', {
          timeZone: 'Europe/Berlin'
        });
        li.textContent = `${date}: ${entry.quantity || 1}x ${entry.product_name} ‚Äì ${entry.price.toFixed(2)} ‚Ç¨`;
        list.appendChild(li);
      });
    }

    loadUserData().then(() => {
  loadCategories().then(() => {
    loadProducts();
    if (currentUser?.id) loadPurchaseHistory();
  });
});


    document.getElementById('search').addEventListener('input', loadProducts);
    document.getElementById('category-filter').addEventListener('change', loadProducts);
    document.getElementById('sort-products').addEventListener('change', loadProducts);
    document.getElementById('sort-history').addEventListener('change', loadPurchaseHistory);
  </script>
  </body>
</html>
