<!doctype html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Rischis Kiosk" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="theme-color" content="#0f172a" />
  <title>Mentos ‚Äì F√ºtterungstracker</title>
  <meta name="description" content="F√ºtterungszeiten f√ºr Mentos protokollieren" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Poppins:wght@700&display=swap"
    rel="stylesheet" />
  <link rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%2310b981' stroke='%230ea5e9' stroke-width='6'/%3E%3Ctext x='50' y='60' font-size='48' text-anchor='middle' fill='white' font-family='Poppins,sans-serif'%3ER%3C/text%3E%3C/svg%3E"
    type="image/svg+xml">
  <style>
    html {
      scroll-behavior: smooth;
      background: linear-gradient(120deg, #f0fdfa 0%, #bbf7d0 50%, #22d3ee 100%);
    }

    html.dark {
      background: linear-gradient(120deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      color-scheme: dark;
    }

    body {
      font-family: 'Inter', sans-serif;
      max-width: 100vw;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
    }

    h1,
    h2 {
      font-family: 'Poppins', sans-serif;
    }

    .panel-shadow {
      box-shadow: 0 8px 32px 0 rgba(34, 197, 94, 0.25), 0 1.5px 4px 0 rgba(0, 0, 0, 0.08);
    }

    .dark .panel-shadow {
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
    }

    .glass-effect {
      backdrop-filter: blur(18px) saturate(120%);
      background-color: rgba(255, 255, 255, 0.92);
      border: 1.5px solid rgba(16, 185, 129, 0.13);
    }

    .dark .glass-effect {
      background-color: rgba(31, 41, 55, 0.92);
      border: 1.5px solid rgba(16, 185, 129, 0.13);
    }

    input,
    select,
    textarea {
      background-color: #f0fdfa;
      color: #134e4a;
      border-radius: 1.2em;
      border: 2px solid #6ee7b7;
      transition: border 0.2s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #22d3ee;
      outline: none;
    }

    ::placeholder {
      color: #6b7280;
      opacity: 1;
    }

    .dark input,
    .dark select,
    .dark textarea {
      background-color: #374151;
      color: #f0fdfa;
      border-color: #22d3ee;
    }

    .dark ::placeholder {
      color: #9ca3af;
    }

    .btn-main {
      background: linear-gradient(90deg, #22d3ee 0%, #10b981 100%);
      color: white;
      font-weight: 700;
      border: none;
      border-radius: 9999px;
      box-shadow: 0 4px 16px 0 rgba(34, 197, 94, 0.18);
      transition: transform 0.15s, box-shadow 0.15s, background 0.2s;
    }

    .btn-main:hover {
      transform: scale(1.04) translateY(-2px);
      box-shadow: 0 8px 32px 0 rgba(34, 197, 94, 0.25);
      background: linear-gradient(90deg, #10b981 0%, #22d3ee 100%);
    }

    .link-underline {
      color: #0ea5e9;
      text-decoration: underline;
      transition: color 0.2s;
    }

    .link-underline:hover {
      color: #10b981;
    }
  </style>
</head>

<body class="text-green-900 relative dark:text-white" aria-label="Mentos F√ºtterungstracker">
  <div class="fixed bottom-4 right-4 z-50">
    <button onclick="toggleDarkMode()"
      class="bg-gray-300/75 dark:bg-gray-700/75 text-black dark:text-white p-2 rounded-full shadow opacity-70 hover:opacity-100 transition focus:ring-2 focus:ring-cyan-400"
      aria-label="Darkmode umschalten" title="Darkmode umschalten">
      üåô
    </button>
  </div>

  <div class="fixed top-4 left-4 z-50">
    <a href="dashboard.html" class="btn-main flex items-center gap-2 py-2 px-4 text-sm shadow">
      <svg xmlns='http://www.w3.org/2000/svg' class='w-5 h-5' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7' />
      </svg>
      Zur√ºck zum Dashboard
    </a>
  </div>

  <div
    class="w-full px-3 py-2 max-w-screen-sm mx-auto mt-12 sm:mt-20 p-6 sm:p-10 rounded-3xl panel-shadow glass-effect animate-fade-in border border-green-200 dark:border-green-900">
    <h1
      class="text-4xl sm:text-5xl font-bold mb-8 text-center text-green-800 dark:text-green-300 flex items-center justify-center gap-2">
      <svg xmlns='http://www.w3.org/2000/svg' class='inline w-9 h-9 text-green-500' fill='none' viewBox='0 0 24 24'
        stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2'
          d='M12 8c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3zm0 10c-4.418 0-8-1.79-8-4V7c0-2.21 3.582-4 8-4s8 1.79 8 4v7c0 2.21-3.582 4-8 4z' />
      </svg>
      Mentos üê±
    </h1>
    <h2 class="text-xl text-center">Letzte F√ºtterung vor:</h2>
    <div id="last-feed" class="text-4xl sm:text-5xl font-mono font-semibold text-center mb-4">
      -
    </div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mb-6">
      <button id="btn-nass"
        class="btn-main bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow focus:ring-2 focus:ring-cyan-400"
        aria-label="Nassfutter gegeben" title="Nassfutter gegeben"
        style="background:linear-gradient(90deg,#38bdf8 0%,#0ea5e9 100%);">
        üêü Nassfutter gegeben
      </button>
      <button id="btn-trocken"
        class="btn-main bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-full shadow focus:ring-2 focus:ring-cyan-400"
        aria-label="Trockenfutter gegeben" title="Trockenfutter gegeben"
        style="background:linear-gradient(90deg,#fbbf24 0%,#f59e42 100%);">
        ü•£ Trockenfutter gegeben
      </button>
    </div>

    <div id="admin-buttons" class="hidden flex flex-col sm:flex-row justify-center gap-4 mb-6">
      <button id="reset-timer-btn"
        class="btn-main bg-red-600 hover:bg-red-700 text-white font-bold text-xs py-1 px-2 rounded-full shadow focus:ring-2 focus:ring-cyan-400"
        aria-label="Timer zur√ºcksetzen" title="Timer zur√ºcksetzen"
        style="background:linear-gradient(90deg,#ef4444 0%,#f59e42 100%);">
        ‚è±Ô∏è Timer zur√ºcksetzen
      </button>
      <button id="clear-history-btn"
        class="btn-main bg-red-600 hover:bg-red-700 text-white font-bold text-xs py-1 px-2 rounded-full shadow focus:ring-2 focus:ring-cyan-400"
        aria-label="Anzeige l√∂schen" title="Anzeige l√∂schen"
        style="background:linear-gradient(90deg,#ef4444 0%,#f59e42 100%);">
        üóëÔ∏è Anzeige l√∂schen
      </button>
    </div>
    <div class="overflow-x-auto">
      <table class="table-auto w-full text-center text-base">
        <thead>
          <tr>
            <th class="px-2 py-1 border-b font-semibold">Zeit</th>
            <th class="px-2 py-1 border-b font-semibold">Futterart</th>
            <th class="px-2 py-1 border-b font-semibold">Gef√ºttert von</th>
          </tr>
        </thead>
        <tbody id="feedings-body"></tbody>
      </table>
    </div>
  </div>

  <script>
    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark ? 'true' : 'false');
    }
    // Automatischer Darkmode nach System
    if (localStorage.getItem('darkMode') === null) {
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.classList.add('dark');
      }
    } else if (localStorage.getItem('darkMode') !== 'false') {
      document.documentElement.classList.add('dark');
    }

    // Einheitliche Definition f√ºr alle Frontend-Skripte
    const BACKEND_URL = window.location.origin;

    async function getCsrfToken() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/csrf-token`, {
          credentials: 'include',
        });
        const data = await res.json();
        return data.csrfToken;
      } catch (err) {
        console.error('CSRF-Token konnte nicht geladen werden', err);
        return null;
      }
    }

    let countdownInterval;

    const adminButtons = document.getElementById('admin-buttons');
    const resetTimerBtn = document.getElementById('reset-timer-btn');
    const clearHistoryBtn = document.getElementById('clear-history-btn');

    fetch(`${BACKEND_URL}/api/user`, { credentials: 'include' })
      .then((r) => (r.ok ? r.json() : null))
      .then((user) => {
        if (user) {
          if (user.role === 'admin') {
            adminButtons.classList.remove('hidden');
          }
        }
      });

    async function loadFeedings() {
      const res = await fetch(`${BACKEND_URL}/api/feedings`);
      if (!res.ok) return;
      const data = await res.json();
      updateTable(data);
      if (data.length) startCountdown(new Date(data[0].zeitstempel));
    }

    function updateTable(entries) {
      const body = document.getElementById('feedings-body');
      body.innerHTML = entries
        .map(
          (e) => `
        <tr class="odd:bg-green-50 dark:odd:bg-gray-700">
          <td class="px-2 py-1 border-b">${new Date(e.zeitstempel).toLocaleString('de-DE', { timeZone: 'Europe/Berlin' })}</td>
          <td class="px-2 py-1 border-b">${e.futterart}</td>
          <td class="px-2 py-1 border-b">${e.gefuettert_von || ''}</td>
        </tr>`,
        )
        .join('');
    }

    function startCountdown(time) {
      clearInterval(countdownInterval);
      function update() {
        const diff = Date.now() - time.getTime();
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const display = document.getElementById('last-feed');
        display.textContent = `${hours}h ${minutes}m`;
        display.classList.remove(
          'text-green-600',
          'text-orange-600',
          'text-red-600',
        );
        if (hours < 4) display.classList.add('text-green-600');
        else if (hours < 8) display.classList.add('text-orange-600');
        else display.classList.add('text-red-600');
      }
      update();
      countdownInterval = setInterval(update, 60000);
    }

    async function addFeeding(type) {
      const token = await getCsrfToken();
      await fetch(`${BACKEND_URL}/api/feedings`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-csrf-token': token,
        },
        credentials: 'include',
        body: JSON.stringify({ type }),
      });
      loadFeedings();
    }

    document
      .getElementById('btn-nass')
      .addEventListener('click', () => addFeeding('Nassfutter'));
    document
      .getElementById('btn-trocken')
      .addEventListener('click', () => addFeeding('Trockenfutter'));

    function resetTimerDisplay() {
      clearInterval(countdownInterval);
      const display = document.getElementById('last-feed');
      display.textContent = '-';
      display.classList.remove(
        'text-green-600',
        'text-orange-600',
        'text-red-600',
      );
    }

    async function clearFeedingHistory() {
      const token = await getCsrfToken();
      await fetch(`${BACKEND_URL}/api/feedings`, {
        method: 'DELETE',
        headers: { 'x-csrf-token': token },
        credentials: 'include',
      });
      resetTimerDisplay();
      loadFeedings();
    }

    resetTimerBtn.addEventListener('click', () => {
      if (confirm('Timer wirklich zur√ºcksetzen?')) {
        resetTimerDisplay();
      }
    });
    clearHistoryBtn.addEventListener('click', () => {
      if (confirm('Anzeige wirklich l√∂schen?')) {
        clearFeedingHistory();
      }
    });

    loadFeedings();
  </script>
</body>

</html>
