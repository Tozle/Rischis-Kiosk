(()=>{function O(){let e=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",e?"true":"false")}localStorage.getItem("darkMode")!=="false"&&document.documentElement.classList.add("dark");window.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("darkmode-toggle-btn");e&&e.addEventListener("click",O);let n=document.getElementById("load-more-purchases");n&&typeof T=="function"&&n.addEventListener("click",t=>{t.preventDefault(),T()})});function $(e){document.querySelectorAll(".tab-content").forEach(s=>s.style.display="none"),document.querySelectorAll("#admin-tabs button").forEach(s=>s.classList.remove("bg-cyan-600","text-white"));let n=document.getElementById("section-"+e);n&&(n.style.display="");let t=document.querySelector(`#admin-tabs [data-tab="${e}"]`);t&&t.classList.add("bg-cyan-600","text-white")}window.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("#admin-tabs button").forEach(e=>{e.addEventListener("click",()=>$(e.getAttribute("data-tab")))}),$("products")});var p=document.getElementById("product-image-url"),u=null;p&&(u=document.createElement("img"),u.alt="Vorschau",u.className="mt-2 max-h-32 rounded shadow hidden",p.parentNode.insertBefore(u,p.nextSibling),p.addEventListener("input",()=>{let e=p.value.trim();e&&/\.(jpg|jpeg|png|webp|gif|svg)$/i.test(e)?(u.src=e,u.classList.remove("hidden")):(u.src="",u.classList.add("hidden"))}));var f=[];function y(){var t,s;let e=((s=(t=document.getElementById("purchase-search"))==null?void 0:t.value)==null?void 0:s.toLowerCase())||"",n=f.filter(a=>{if(!e)return!0;let r=new Date(a.created_at).toLocaleDateString("de-DE"),o=a.price.toFixed(2).replace(".",",");return a.user_name.toLowerCase().includes(e)||a.product_name.toLowerCase().includes(e)||r.includes(e)||o.includes(e)});_(n)}function _(e){let n=document.getElementById("purchase-history");n.innerHTML="";let t=document.createElement("li");t.className="grid grid-cols-4 gap-2 font-bold text-green-800 dark:text-green-200 mb-1 px-2",t.innerHTML=`
    <span>Datum</span>
    <span>Name</span>
    <span>Menge & Produkt</span>
    <span>Preis</span>
  `,n.appendChild(t),e.forEach(s=>{let a=document.createElement("li");a.className="grid grid-cols-4 gap-2 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-xl p-2 shadow-sm mb-2 items-center",a.innerHTML=`
      <span class="text-xs text-gray-500 dark:text-gray-400">${R(s.created_at)}</span>
      <span class="font-semibold">${s.user_name}</span>
      <span>${s.quantity||1}x ${s.product_name}</span>
      <span class="font-bold">${s.price.toFixed(2)} \u20AC</span>
    `,n.appendChild(a)})}function F(){var o,c;let e=((c=(o=document.getElementById("purchase-search"))==null?void 0:o.value)==null?void 0:c.toLowerCase())||"",n=f.filter(i=>i.user_name.toLowerCase().includes(e)||i.product_name.toLowerCase().includes(e)),t=["Datum,Uhrzeit,Nutzer,Produkt,Menge,Preis"];n.forEach(i=>{let m=new Date(i.created_at),d=m.toLocaleDateString("de-DE"),g=m.toLocaleTimeString("de-DE");t.push(`"${d}","${g}","${i.user_name.replace(/"/g,'""')}","${i.product_name.replace(/"/g,'""')}",${i.quantity||1},${i.price.toFixed(2)}`)});let s=new Blob([t.join(`
`)],{type:"text/csv"}),a=URL.createObjectURL(s),r=document.createElement("a");r.href=a,r.download="kaeufe.csv",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}var v=[];function B(){var t,s;let e=((s=(t=document.getElementById("user-search"))==null?void 0:t.value)==null?void 0:s.toLowerCase())||"",n=v.filter(a=>a.name.toLowerCase().includes(e)||a.email.toLowerCase().includes(e));A(n)}function A(e){let n=document.getElementById("user-manage-list");n.innerHTML="",e.forEach(a=>{let r=document.createElement("li");r.className="flex flex-col sm:flex-row sm:items-center justify-between gap-2 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-xl p-3 shadow-sm mb-2",r.innerHTML=`
      <div class="flex flex-col sm:flex-row sm:items-center gap-2 flex-1">
        <span class="font-semibold text-green-900 dark:text-green-200">${a.name}</span>
        <span class="text-xs text-gray-500 dark:text-gray-400">${a.email}</span>
      </div>
      <div class="flex gap-2 mt-2 sm:mt-0">
        <button class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 flex items-center gap-1 text-xs" title="Bearbeiten" onclick="editUser('${a.id}', '${a.name}')">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11 5h2m-1 0v14m-7-7h14' /></svg>
          Bearbeiten
        </button>
        <button class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 flex items-center gap-1 text-xs" title="L\xF6schen" onclick="deleteUser('${a.id}')">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12' /></svg>
          L\xF6schen
        </button>
      </div>
    `,n.appendChild(r)});let t=null;async function s(a){if(!await H("Benutzer wirklich l\xF6schen? Alle K\xE4ufe bleiben erhalten."))return;h(!0);let c=(await(await fetch(`${l}/api/admin/users`,{credentials:"include"})).json()).find(m=>m.id===a);t=c?{...c}:null;let i=await b();await fetch(`${l}/api/admin/users/${a}`,{method:"DELETE",credentials:"include",headers:{"x-csrf-token":i}}),h(!1),C("Benutzer gel\xF6scht.","success",5e3,async()=>{if(!t)return;h(!0);let m=await b();await fetch(`${l}/api/admin/users`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)}),h(!1),C("L\xF6schung r\xFCckg\xE4ngig gemacht!","success"),x(),t=null}),x()}window.deleteUser=s}function z(){var o,c;let e=((c=(o=document.getElementById("user-search"))==null?void 0:o.value)==null?void 0:c.toLowerCase())||"",n=v.filter(i=>i.name.toLowerCase().includes(e)||i.email.toLowerCase().includes(e)),t=["Name,Email"];n.forEach(i=>{t.push(`"${i.name.replace(/"/g,'""')}","${i.email.replace(/"/g,'""')}"`)});let s=new Blob([t.join(`
`)],{type:"text/csv"}),a=URL.createObjectURL(s),r=document.createElement("a");r.href=a,r.download="benutzer.csv",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}function C(e,n="success",t=3e3,s=null){let a=document.getElementById("toast");if(!a)return;a.innerHTML="";let r=document.createElement("span");if(r.textContent=e,a.appendChild(r),s){let o=document.createElement("button");o.textContent="R\xFCckg\xE4ngig",o.className="ml-4 px-3 py-1 rounded bg-white/80 text-green-700 font-bold shadow hover:bg-green-100 transition text-xs",o.onclick=()=>{s(),a.classList.add("opacity-0")},a.appendChild(o)}a.className=`fixed left-1/2 top-6 z-50 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-center text-sm font-semibold transition-opacity duration-300 pointer-events-none ${n==="error"?"bg-red-600":"bg-green-600"} text-white opacity-100`,s||setTimeout(()=>{a.classList.add("opacity-0")},t)}function h(e=!0){let n=document.getElementById("loader");n&&n.classList.toggle("hidden",!e)}async function H(e){return new Promise(n=>{window.confirm(e)?n(!0):n(!1)})}var l=window.location.origin,M=null;async function b(){try{return(await(await fetch(`${l}/api/csrf-token`,{credentials:"include"})).json()).csrfToken}catch(e){return console.error("CSRF-Token konnte nicht geladen werden",e),null}}localStorage.getItem("darkMode")!=="false"&&document.documentElement.classList.add("dark");function R(e){let n=new Date(e);return n.toLocaleDateString("de-DE",{timeZone:"Europe/Berlin"})+" "+n.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Europe/Berlin"})}async function V(){try{let e=await fetch(`${l}/api/user`,{credentials:"include"});e.ok&&(M=(await e.json()).id)}catch(e){console.error("Fehler beim Laden des Benutzers",e)}}async function w(){var a;let e=((a=document.getElementById("category-filter"))==null?void 0:a.value)||"all",t=await(await fetch(`${l}/api/admin/products`,{credentials:"include"})).json(),s=document.getElementById("product-list");s.innerHTML="",t.filter(r=>e==="all"||r.category===e).forEach(r=>{let o=document.createElement("li");o.className="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 p-4 rounded-2xl shadow-md hover:shadow-lg transition-all flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4";let c=r.image_url&&r.image_url.trim()!=="";o.innerHTML=`
      <div class="flex items-center gap-4 flex-1">
        ${c?`<img src="${r.image_url}" alt="${r.name}" class="w-16 h-16 object-contain rounded shadow border border-gray-200 dark:border-gray-700 bg-white" loading="lazy">`:""}
        <div>
          <div class="flex items-center gap-2 mb-1">
            <span class="text-base font-semibold">${r.name}</span>
            <span class="inline-block px-2 py-0.5 rounded text-xs font-bold ${r.available?"bg-green-200 text-green-800 dark:bg-green-700 dark:text-green-200":"bg-red-200 text-red-800 dark:bg-red-700 dark:text-red-200"}">
              ${r.available?"Verf\xFCgbar":"Versteckt"}
            </span>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-300">
            <span>Preis: <strong>${r.price.toFixed(2)} \u20AC</strong></span> \u2013
            <span>Bestand: <strong>${r.stock}</strong></span> \u2013
            <span>Kategorie: <strong>${r.category||"-"}</strong></span>
          </div>
        </div>
      </div>
      <div class="flex flex-row gap-2 mt-3 sm:mt-0 sm:ml-4">
        <button onclick="toggleAvailability('${r.id}', ${r.available})" class="bg-yellow-500 text-white text-xs px-2 py-1 rounded shadow hover:bg-yellow-600 focus:outline-none flex items-center gap-1" title="${r.available?"Verstecken":"Anzeigen"}">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7' /></svg>
          ${r.available?"Verstecken":"Anzeigen"}
        </button>
        <button onclick="editProduct('${r.id}')" class="bg-blue-600 text-white text-xs px-2 py-1 rounded shadow hover:bg-blue-700 focus:outline-none flex items-center gap-1" title="Bearbeiten">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11 5h2m-1 0v14m-7-7h14' /></svg>
          Bearbeiten
        </button>
        <button onclick="deleteProduct('${r.id}')" class="bg-red-600 text-white text-xs px-2 py-1 rounded shadow hover:bg-red-700 focus:outline-none flex items-center gap-1" title="L\xF6schen">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12' /></svg>
          L\xF6schen
        </button>
      </div>
    `,s.appendChild(o)})}var P;(P=document.getElementById("category-filter"))==null||P.addEventListener("change",w);async function J(e){var E;e.preventDefault();let n=e.target.querySelector('button[type="submit"]');n&&(n.disabled=!0);let t=document.getElementById("product-name").value.trim(),s=parseFloat(document.getElementById("product-price").value.replace(",",".")),a=parseFloat(document.getElementById("product-purchase").value.replace(",",".")),r=parseInt(document.getElementById("product-stock").value),o=document.getElementById("product-category").value,c=document.getElementById("product-result"),i=((E=p==null?void 0:p.value)==null?void 0:E.trim())||"";if(i&&!/\.(jpg|jpeg|png|webp|gif|svg)$/i.test(i)){c.textContent="Bitte eine g\xFCltige Bild-URL angeben (jpg, png, webp, gif, svg)!",c.classList.add("text-red-600"),n&&(n.disabled=!1);return}if(!t||isNaN(s)||isNaN(a)||isNaN(r)||!o){c.textContent="Bitte alle Felder korrekt ausf\xFCllen!",c.classList.add("text-red-600"),n&&(n.disabled=!1);return}let m=await b(),d=await fetch(`${l}/api/admin/products`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":m},credentials:"include",body:JSON.stringify({name:t,price:s,purchase_price:a,stock:r,category:o,created_by:M,image_url:i})}),g=await d.json();c.textContent=d.ok?"Produkt gespeichert!":`Fehler: ${g.error}`,c.classList.toggle("text-red-600",!d.ok),c.classList.toggle("text-green-700",d.ok),d.ok&&(e.target.reset(),u&&(u.src="",u.classList.add("hidden")),L(),w(),document.querySelector('[data-tab="products"]').click()),n&&(n.disabled=!1),setTimeout(()=>{c.textContent="",c.classList.remove("text-red-600","text-green-700")},3e3)}var j;(j=document.getElementById("add-product"))==null||j.addEventListener("submit",J);async function L(){let e=await fetch(`${l}/api/admin/stats`,{credentials:"include"});if(!e.ok)return;let{users:n,totalBalance:t,shopValue:s,totalRevenue:a,totalCost:r,profit:o}=await e.json();document.getElementById("stats").innerHTML=`
    <p class="mt-4 text-sm"><strong>Produkte im Shop:</strong> ${n.length}</p>
    <p class="text-sm"><strong>Shop-Warenwert:</strong> ${s.toFixed(2)} \u20AC</p>
    <hr class="my-3" />
    <p class="text-sm"><strong>Verkaufserl\xF6se:</strong> ${a.toFixed(2)} \u20AC</p>
    <p class="text-sm"><strong>Einkaufskosten:</strong> ${r.toFixed(2)} \u20AC</p>
    <p class="text-sm"><strong>Gewinn / Verlust:</strong> <span class="${o>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}">${o.toFixed(2)} \u20AC</span></p>
    <hr class="my-3" />
    <p class="text-sm"><strong>Gesamtsaldo aller Nutzer:</strong> <span class="${t>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}">${t.toFixed(2)} \u20AC</span></p>`}var S=0,I=20;async function N(e=!1){var s;let t=await(await fetch(`${l}/api/admin/purchases?offset=${S}&limit=${I}`,{credentials:"include"})).json();e?(f=t,y()):(f=f.concat(t),y()),S+=I,(s=document.getElementById("purchase-search"))==null||s.addEventListener("input",y)}function T(){N(!1)}async function x(){v=await(await fetch(`${l}/api/admin/users`,{credentials:"include"})).json(),B(),window.addEventListener("DOMContentLoaded",()=>{var s,a;let t=document.getElementById("darkmode-toggle");t&&(t.onclick=()=>{toggleDarkMode();let r=document.getElementById("darkmode-icon-path");document.documentElement.classList.contains("dark")?r.setAttribute("d","M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"):r.setAttribute("d","M12 3v1m0 16v1m8.66-13.66l-.71.71M4.05 19.95l-.71.71M21 12h-1M4 12H3m16.66 5.66l-.71-.71M4.05 4.05l-.71-.71M16 12a4 4 0 11-8 0 4 4 0 018 0z")}),(s=document.getElementById("user-search"))==null||s.addEventListener("input",B),(a=document.getElementById("export-users"))==null||a.addEventListener("click",z)})}async function U(){let n=await(await fetch(`${l}/api/admin/users`,{credentials:"include"})).json();document.getElementById("balance-control-list").innerHTML=n.map(t=>{let s=t.balance<0?"text-red-600 dark:text-red-400 font-bold":"text-green-600 dark:text-green-400 font-bold";return`<li class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-xl p-3 shadow-sm mb-2">
      <span class="flex-1 font-semibold">${t.name}: <span class="${s}">${t.balance.toFixed(2)} \u20AC</span></span>
      <div class="flex gap-2 mt-2 sm:mt-0">
        <input type="number" id="bal-${t.id}" class="w-20 border px-2 py-1 rounded" step="0.01" />
        <button onclick="updateBalance('${t.id}', 'add')" class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 flex items-center gap-1 text-xs" title="Guthaben erh\xF6hen">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 4v16m8-8H4' /></svg>
        </button>
        <button onclick="updateBalance('${t.id}', 'subtract')" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 flex items-center gap-1 text-xs" title="Guthaben verringern">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M20 12H4' /></svg>
        </button>
      </div>
    </li>`}).join("")}async function K(){let n=await(await fetch(`${l}/api/admin/users`,{credentials:"include"})).json(),t=document.getElementById("buy-user");t&&(t.innerHTML=n.map(s=>`<option value="${s.id}">${s.name}</option>`).join(""))}var k=[];function D(e){let n=document.getElementById("buy-product-list");n&&(n.innerHTML="",e.forEach(t=>{let s=document.createElement("div");s.className="border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-xl p-4 shadow flex flex-col items-center",s.innerHTML=`
      ${t.image_url?`<img src="${t.image_url}" alt="${t.name}" class="w-20 h-20 object-contain mb-2 rounded shadow">`:""}
      <div class="font-semibold text-center mb-1">${t.name}</div>
      <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">${t.price.toFixed(2)} \u20AC</div>
      <div class="text-xs text-gray-500 mb-2">Bestand: ${t.stock}</div>
      <div class="flex gap-1 items-center mb-2">
        <input type="number" min="1" max="${t.stock}" value="1" class="buy-qty-input p-1 border rounded w-14 text-center" aria-label="Menge" />
      </div>
      <button class="buy-for-user-btn btn-main bg-blue-600 text-white px-3 py-1 rounded shadow hover:bg-blue-700 w-full" data-product-id="${t.id}" ${t.stock<1?"disabled":""}>Kaufen</button>
    `,n.appendChild(s)}))}async function q(){k=(await(await fetch(`${l}/api/admin/products`,{credentials:"include"})).json()).filter(t=>t.available&&t.stock>0),D(k)}function G(){var t,s;let e=((s=(t=document.getElementById("buy-product-search"))==null?void 0:t.value)==null?void 0:s.toLowerCase())||"",n=k.filter(a=>a.name.toLowerCase().includes(e)||a.category&&a.category.toLowerCase().includes(e));D(n)}async function Z(e,n){var c;let t=(c=document.getElementById("buy-user"))==null?void 0:c.value;if(!t||!e||isNaN(n)||n<=0)return;let s=await b(),a=await fetch(`${l}/api/admin/buy`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":s},credentials:"include",body:JSON.stringify({user_id:t,product_id:e,quantity:n})}),r=await a.json(),o=document.getElementById("buy-for-user-result");o.textContent=a.ok?"Kauf durchgef\xFChrt":r.error||"Fehler",a.ok&&(L(),w(),U(),q())}window.addEventListener("DOMContentLoaded",()=>{var e,n,t;V(),L(),w(),N(!0),x(),U(),K(),q(),(e=document.getElementById("export-purchases"))==null||e.addEventListener("click",F),(n=document.getElementById("buy-product-search"))==null||n.addEventListener("input",G),(t=document.getElementById("buy-product-list"))==null||t.addEventListener("click",function(s){if(s.target.classList.contains("buy-for-user-btn")){let a=s.target.closest("div"),r=s.target.getAttribute("data-product-id"),o=a.querySelector(".buy-qty-input"),c=parseInt(o.value||"1");Z(r,c)}}),typeof startSessionCheck=="function"&&startSessionCheck()});window.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("faq-btn"),n=document.getElementById("faq-overlay"),t=document.getElementById("faq-close");e&&n&&t&&(e.addEventListener("click",()=>{n.classList.remove("hidden"),t.focus()}),t.addEventListener("click",()=>{n.classList.add("hidden"),e.focus()}),n.addEventListener("click",d=>{d.target===n&&(n.classList.add("hidden"),e.focus())}),document.addEventListener("keydown",d=>{!n.classList.contains("hidden")&&(d.key==="Escape"||d.key==="Esc")&&(n.classList.add("hidden"),e.focus())}));let s=document.getElementById("darkModeBtn");s&&s.addEventListener("click",()=>{let d=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",d?"true":"false")}),localStorage.getItem("darkMode")===null?(document.documentElement.classList.add("dark"),localStorage.setItem("darkMode","true")):localStorage.getItem("darkMode")!=="false"?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");let a=document.querySelectorAll("#admin-tabs button[data-tab]"),r=document.querySelectorAll(".tab-content");function o(d){r.forEach(function(g){g.id==="section-"+d?g.style.display="":g.style.display="none"}),a.forEach(function(g){g.classList.toggle("ring-2",g.dataset.tab===d)})}a.forEach(function(d){d.addEventListener("click",function(){o(d.dataset.tab)})}),o("products");let c=document.getElementById("logoutBtn");c&&c.addEventListener("click",()=>{fetch("/api/logout",{method:"POST",credentials:"include"}).finally(()=>{sessionStorage.clear(),window.location.href="/index.html"})});let i;function m(){clearTimeout(i),i=setTimeout(()=>{alert("Session abgelaufen. Du wirst abgemeldet."),fetch("/api/logout",{method:"POST",credentials:"include"}).finally(()=>{sessionStorage.clear(),window.location.href="/index.html"})},1200*1e3)}["click","keydown","mousemove","touchstart"].forEach(d=>{window.addEventListener(d,m)}),m()});})();
