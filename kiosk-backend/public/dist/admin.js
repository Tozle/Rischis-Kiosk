(()=>{async function I(){try{let n=await(await fetch("/api/auth/me",{credentials:"include"})).json();return n.loggedIn&&n.user?n.user:null}catch(e){return null}}I().then(e=>{(!e||e.role!=="admin"&&e.role!=="superadmin")&&(window.location.href="/index.html")});function z(){let e=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",e?"true":"false")}localStorage.getItem("darkMode")!=="false"&&document.documentElement.classList.add("dark");window.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("darkmode-toggle-btn");e&&e.addEventListener("click",z);let n=document.getElementById("load-more-purchases");n&&typeof M=="function"&&n.addEventListener("click",s=>{s.preventDefault(),M()})});function S(e){document.querySelectorAll(".tab-content").forEach(r=>r.style.display="none"),document.querySelectorAll("#admin-tabs button").forEach(r=>r.classList.remove("bg-cyan-600","text-white"));let n=document.getElementById("section-"+e);n&&(n.style.display="");let s=document.querySelector(`#admin-tabs [data-tab="${e}"]`);s&&s.classList.add("bg-cyan-600","text-white")}window.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("#admin-tabs button").forEach(e=>{e.addEventListener("click",()=>S(e.getAttribute("data-tab")))}),S("products")});var y=document.getElementById("product-image-url"),h=null;y&&(h=document.createElement("img"),h.alt="Vorschau",h.className="mt-2 max-h-32 rounded shadow hidden",y.parentNode.insertBefore(h,y.nextSibling),y.addEventListener("input",()=>{let e=y.value.trim();e&&/\.(jpg|jpeg|png|webp|gif|svg)$/i.test(e)?(h.src=e,h.classList.remove("hidden")):(h.src="",h.classList.add("hidden"))}));var x=[];function L(){var s,r;let e=((r=(s=document.getElementById("purchase-search"))==null?void 0:s.value)==null?void 0:r.toLowerCase())||"",n=x.filter(a=>{if(!e)return!0;let t=new Date(a.created_at).toLocaleDateString("de-DE"),o=a.price.toFixed(2).replace(".",",");return a.user_name.toLowerCase().includes(e)||a.product_name.toLowerCase().includes(e)||t.includes(e)||o.includes(e)});H(n)}function H(e){let n=document.getElementById("purchase-history");n.innerHTML="";let s=document.createElement("li");s.className="grid grid-cols-4 gap-2 font-bold text-green-800 dark:text-green-200 mb-1 px-2",s.innerHTML=`
    <span>Datum</span>
    <span>Name</span>
    <span>Menge & Produkt</span>
    <span>Preis</span>
  `,n.appendChild(s),e.forEach(r=>{let a=document.createElement("li");a.className="grid grid-cols-4 gap-2 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-xl p-2 shadow-sm mb-2 items-center",a.innerHTML=`
      <span class="text-xs text-gray-500 dark:text-gray-400">${K(r.created_at)}</span>
      <span class="font-semibold">${r.user_name}</span>
      <span>${r.quantity||1}x ${r.product_name}</span>
      <span class="font-bold">${r.price.toFixed(2)} \u20AC</span>
    `,n.appendChild(a)})}function R(){var o,d;let e=((d=(o=document.getElementById("purchase-search"))==null?void 0:o.value)==null?void 0:d.toLowerCase())||"",n=x.filter(i=>i.user_name.toLowerCase().includes(e)||i.product_name.toLowerCase().includes(e)),s=["Datum,Uhrzeit,Nutzer,Produkt,Menge,Preis"];n.forEach(i=>{let u=new Date(i.created_at),c=u.toLocaleDateString("de-DE"),f=u.toLocaleTimeString("de-DE");s.push(`"${c}","${f}","${i.user_name.replace(/"/g,'""')}","${i.product_name.replace(/"/g,'""')}",${i.quantity||1},${i.price.toFixed(2)}`)});let r=new Blob([s.join(`
`)],{type:"text/csv"}),a=URL.createObjectURL(r),t=document.createElement("a");t.href=a,t.download="kaeufe.csv",document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(a)}var B=[];function T(){var s,r;let e=((r=(s=document.getElementById("user-search"))==null?void 0:s.value)==null?void 0:r.toLowerCase())||"",n=B.filter(a=>a.name.toLowerCase().includes(e)||a.email.toLowerCase().includes(e));V(n)}function V(e){let n=document.getElementById("user-manage-list");n.innerHTML="",e.forEach(a=>{let t=document.createElement("li");t.className="flex flex-col sm:flex-row sm:items-center justify-between gap-2 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-xl p-3 shadow-sm mb-2",t.innerHTML=`
      <div class="flex flex-col sm:flex-row sm:items-center gap-2 flex-1">
        <span class="font-semibold text-green-900 dark:text-green-200">${a.name}</span>
        <span class="text-xs text-gray-500 dark:text-gray-400">${a.email}</span>
      </div>
      <div class="flex gap-2 mt-2 sm:mt-0">
        <button class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 flex items-center gap-1 text-xs edit-user-btn" data-id="${a.id}" data-name="${a.name}" title="Bearbeiten">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11 5h2m-1 0v14m-7-7h14' /></svg>
          Bearbeiten
        </button>
        <button class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 flex items-center gap-1 text-xs delete-user-btn" data-id="${a.id}" title="L\xF6schen">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12' /></svg>
          L\xF6schen
        </button>
      </div>
    `,n.appendChild(t)}),n.onclick=function(a){let t=a.target.closest(".edit-user-btn");if(t){Y(t.dataset.id,t.dataset.name);return}let o=a.target.closest(".delete-user-btn");if(o){r(o.dataset.id);return}};let s=null;async function r(a){if(!await q("Benutzer wirklich l\xF6schen? Alle K\xE4ufe bleiben erhalten."))return;m(!0);let d=(await(await fetch(`${l}/api/admin/users`,{credentials:"include"})).json()).find(u=>u.id===a);s=d?{...d}:null;let i=await p();await fetch(`${l}/api/admin/users/${a}`,{method:"DELETE",credentials:"include",headers:{"x-csrf-token":i}}),m(!1),g("Benutzer gel\xF6scht.","success",5e3,async()=>{if(!s)return;m(!0);let u=await p();await fetch(`${l}/api/admin/users`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(s)}),m(!1),g("L\xF6schung r\xFCckg\xE4ngig gemacht!","success"),k(),s=null}),k()}}function J(){var o,d;let e=((d=(o=document.getElementById("user-search"))==null?void 0:o.value)==null?void 0:d.toLowerCase())||"",n=B.filter(i=>i.name.toLowerCase().includes(e)||i.email.toLowerCase().includes(e)),s=["Name,Email"];n.forEach(i=>{s.push(`"${i.name.replace(/"/g,'""')}","${i.email.replace(/"/g,'""')}"`)});let r=new Blob([s.join(`
`)],{type:"text/csv"}),a=URL.createObjectURL(r),t=document.createElement("a");t.href=a,t.download="benutzer.csv",document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(a)}function g(e,n="success",s=3e3,r=null){let a=document.getElementById("toast");if(!a)return;a.innerHTML="";let t=document.createElement("span");if(t.textContent=e,a.appendChild(t),r){let o=document.createElement("button");o.textContent="R\xFCckg\xE4ngig",o.className="ml-4 px-3 py-1 rounded bg-white/80 text-green-700 font-bold shadow hover:bg-green-100 transition text-xs",o.onclick=()=>{r(),a.classList.add("opacity-0")},a.appendChild(o)}a.className=`fixed left-1/2 top-6 z-50 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-center text-sm font-semibold transition-opacity duration-300 pointer-events-none ${n==="error"?"bg-red-600":"bg-green-600"} text-white opacity-100`,r||setTimeout(()=>{a.classList.add("opacity-0")},s)}function m(e=!0){let n=document.getElementById("loader");n&&n.classList.toggle("hidden",!e)}async function q(e){return new Promise(n=>{window.confirm(e)?n(!0):n(!1)})}var l=window.location.origin,D=null;async function p(){try{return(await(await fetch(`${l}/api/csrf-token`,{credentials:"include"})).json()).csrfToken}catch(e){return console.error("CSRF-Token konnte nicht geladen werden",e),null}}function K(e){let n=new Date(e);return n.toLocaleDateString("de-DE",{timeZone:"Europe/Berlin"})+" "+n.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Europe/Berlin"})}async function G(){try{let e=await fetch(`${l}/api/user`,{credentials:"include"});e.ok&&(D=(await e.json()).id)}catch(e){console.error("Fehler beim Laden des Benutzers",e)}}async function b(){var a;let e=((a=document.getElementById("category-filter"))==null?void 0:a.value)||"all",s=await(await fetch(`${l}/api/admin/products`,{credentials:"include"})).json(),r=document.getElementById("product-list");r.innerHTML="",s.filter(t=>e==="all"||t.category===e).forEach(t=>{let o=document.createElement("li");o.className="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 p-4 rounded-2xl shadow-md hover:shadow-lg transition-all flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4";let d=t.image_url&&t.image_url.trim()!=="";o.innerHTML=`
      <div class="flex items-center gap-4 flex-1">
        ${d?`<img src="${t.image_url}" alt="${t.name}" class="w-16 h-16 object-contain rounded shadow border border-gray-200 dark:border-gray-700 bg-white" loading="lazy">`:""}
        <div>
          <div class="flex items-center gap-2 mb-1">
            <span class="text-base font-semibold">${t.name}</span>
            <span class="inline-block px-2 py-0.5 rounded text-xs font-bold ${t.available?"bg-green-200 text-green-800 dark:bg-green-700 dark:text-green-200":"bg-red-200 text-red-800 dark:bg-red-700 dark:text-red-200"}">
              ${t.available?"Verf\xFCgbar":"Versteckt"}
            </span>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-300">
            <span>Preis: <strong>${t.price.toFixed(2)} \u20AC</strong></span> \u2013
            <span>Bestand: <strong>${t.stock}</strong></span> \u2013
            <span>Kategorie: <strong>${t.category||"-"}</strong></span>
          </div>
        </div>
      </div>
      <div class="flex flex-row gap-2 mt-3 sm:mt-0 sm:ml-4">
        <button class="bg-yellow-500 text-white text-xs px-2 py-1 rounded shadow hover:bg-yellow-600 focus:outline-none flex items-center gap-1 toggle-availability-btn" data-id="${t.id}" data-available="${t.available}" title="${t.available?"Verstecken":"Anzeigen"}">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7' /></svg>
          ${t.available?"Verstecken":"Anzeigen"}
        </button>
        <button class="bg-blue-600 text-white text-xs px-2 py-1 rounded shadow hover:bg-blue-700 focus:outline-none flex items-center gap-1 edit-product-btn" data-id="${t.id}" title="Bearbeiten">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11 5h2m-1 0v14m-7-7h14' /></svg>
          Bearbeiten
        </button>
        <button class="bg-red-600 text-white text-xs px-2 py-1 rounded shadow hover:bg-red-700 focus:outline-none flex items-center gap-1 delete-product-btn" data-id="${t.id}" title="L\xF6schen">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12' /></svg>
          L\xF6schen
        </button>
      </div>
    `,r.appendChild(o)}),r.onclick=function(t){let o=t.target.closest(".toggle-availability-btn");if(o){Q(o.dataset.id,o.dataset.available==="true");return}let d=t.target.closest(".edit-product-btn");if(d){W(d.dataset.id);return}let i=t.target.closest(".delete-product-btn");if(i){X(i.dataset.id);return}}}var N;(N=document.getElementById("category-filter"))==null||N.addEventListener("change",b);async function Z(e){var v;e.preventDefault();let n=e.target.querySelector('button[type="submit"]');n&&(n.disabled=!0);let s=document.getElementById("product-name").value.trim(),r=parseFloat(document.getElementById("product-price").value.replace(",",".")),a=parseFloat(document.getElementById("product-purchase").value.replace(",",".")),t=parseInt(document.getElementById("product-stock").value),o=document.getElementById("product-category").value,d=document.getElementById("product-result"),i=((v=y==null?void 0:y.value)==null?void 0:v.trim())||"";if(i&&!/\.(jpg|jpeg|png|webp|gif|svg)$/i.test(i)){d.textContent="Bitte eine g\xFCltige Bild-URL angeben (jpg, png, webp, gif, svg)!",d.classList.add("text-red-600"),n&&(n.disabled=!1);return}if(!s||isNaN(r)||isNaN(a)||isNaN(t)||!o){d.textContent="Bitte alle Felder korrekt ausf\xFCllen!",d.classList.add("text-red-600"),n&&(n.disabled=!1);return}let u=await p(),c=await fetch(`${l}/api/admin/products`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":u},credentials:"include",body:JSON.stringify({name:s,price:r,purchase_price:a,stock:t,category:o,created_by:D,image_url:i})}),f=await c.json();d.textContent=c.ok?"Produkt gespeichert!":`Fehler: ${f.error}`,d.classList.toggle("text-red-600",!c.ok),d.classList.toggle("text-green-700",c.ok),c.ok&&(e.target.reset(),h&&(h.src="",h.classList.add("hidden")),w(),b(),document.querySelector('[data-tab="products"]').click()),n&&(n.disabled=!1),setTimeout(()=>{d.textContent="",d.classList.remove("text-red-600","text-green-700")},3e3)}var U;(U=document.getElementById("add-product"))==null||U.addEventListener("submit",Z);async function W(e){let r=(await(await fetch(`${l}/api/admin/products`,{credentials:"include"})).json()).find(i=>i.id===e);if(!r)return;let a={...r},t=document.createElement("div");t.innerHTML=`
    <div class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-md relative">
        <button id="close-edit-dialog" class="absolute top-2 right-2 text-gray-400 hover:text-red-600 text-xl">&times;</button>
        <h2 class="text-lg font-bold mb-4">Produkt bearbeiten</h2>
        <form id="edit-product-form" class="space-y-3">
          <input type="text" id="edit-product-name" value="${r.name}" required class="w-full p-2 rounded border" placeholder="Name" />
          <input type="number" step="0.01" id="edit-product-price" value="${r.price}" required class="w-full p-2 rounded border" placeholder="Verkaufspreis" />
          <input type="number" id="edit-product-stock" value="${r.stock}" required class="w-full p-2 rounded border" placeholder="Bestand" />
          <div>
            <label class="block text-sm mb-1">Bild-URL (optional)</label>
            <input type="url" id="edit-product-image-url" value="${r.image_url||""}" class="block w-full text-sm" placeholder="Bild-URL" />
            <img id="edit-product-image-preview" src="${r.image_url||""}" alt="Vorschau" class="mt-2 max-h-32 rounded shadow${r.image_url?"":" hidden"}" />
          </div>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Speichern</button>
        </form>
      </div>
    </div>
  `,document.body.appendChild(t),t.querySelector("#close-edit-dialog").onclick=()=>t.remove(),setTimeout(()=>{let i=t.querySelector("input,select,button");i&&i.focus()},50),t.addEventListener("keydown",i=>{i.key==="Escape"&&t.remove()}),t.tabIndex=-1,t.focus();let o=t.querySelector("#edit-product-image-url"),d=t.querySelector("#edit-product-image-preview");o.addEventListener("input",()=>{let i=o.value.trim();i&&/\.(jpg|jpeg|png|webp|gif|svg)$/i.test(i)?(d.src=i,d.classList.remove("hidden")):(d.src="",d.classList.add("hidden"))}),t.querySelector("#edit-product-form").onsubmit=async i=>{i.preventDefault();let u=t.querySelector("#edit-product-name").value,c=t.querySelector("#edit-product-price").value,f=t.querySelector("#edit-product-stock").value,v=o.value.trim(),F=await p();await fetch(`${l}/api/admin/products/${e}`,{method:"PUT",headers:{"Content-Type":"application/json","x-csrf-token":F},credentials:"include",body:JSON.stringify({name:u,price:parseFloat(c),stock:parseInt(f),image_url:v})}),t.remove(),g("Produkt bearbeitet.","success",5e3,async()=>{m(!0);let A=await p();await fetch(`${l}/api/admin/products/${e}`,{method:"PUT",headers:{"Content-Type":"application/json","x-csrf-token":A},credentials:"include",body:JSON.stringify(a)}),m(!1),g("Bearbeitung r\xFCckg\xE4ngig gemacht!","success"),b(),w()}),b(),w()}}async function Q(e,n){let s=await p();await fetch(`${l}/api/admin/products/${e}/available`,{method:"PUT",headers:{"Content-Type":"application/json","x-csrf-token":s},credentials:"include",body:JSON.stringify({available:!n})}),b()}async function X(e){if(!await q("Produkt l\xF6schen (K\xE4ufe bleiben erhalten)?"))return;m(!0);let n=await p(),a=(await(await fetch(`${l}/api/admin/products`,{credentials:"include"})).json()).find(o=>o.id===e),t=a?{...a}:null;await fetch(`${l}/api/admin/products/${e}`,{method:"DELETE",credentials:"include",headers:{"x-csrf-token":n}}),m(!1),g("Produkt gel\xF6scht.","success",5e3,async()=>{if(!t)return;m(!0);let o=await p();await fetch(`${l}/api/admin/products`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},credentials:"include",body:JSON.stringify(t)}),m(!1),g("L\xF6schung r\xFCckg\xE4ngig gemacht!","success"),b(),w(),E(!0)}),b(),w(),E(!0)}async function w(){let e=await fetch(`${l}/api/admin/stats`,{credentials:"include"});if(!e.ok)return;let{users:n,totalBalance:s,shopValue:r,totalRevenue:a,totalCost:t,profit:o}=await e.json();document.getElementById("stats").innerHTML=`
    <p class="mt-4 text-sm"><strong>Produkte im Shop:</strong> ${n.length}</p>
    <p class="text-sm"><strong>Shop-Warenwert:</strong> ${r.toFixed(2)} \u20AC</p>
    <hr class="my-3" />
    <p class="text-sm"><strong>Verkaufserl\xF6se:</strong> ${a.toFixed(2)} \u20AC</p>
    <p class="text-sm"><strong>Einkaufskosten:</strong> ${t.toFixed(2)} \u20AC</p>
    <p class="text-sm"><strong>Gewinn / Verlust:</strong> <span class="${o>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}">${o.toFixed(2)} \u20AC</span></p>
    <hr class="my-3" />
    <p class="text-sm"><strong>Gesamtsaldo aller Nutzer:</strong> <span class="${s>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}">${s.toFixed(2)} \u20AC</span></p>`}var j=0,P=20;async function E(e=!1){var r;let s=await(await fetch(`${l}/api/admin/purchases?offset=${j}&limit=${P}`,{credentials:"include"})).json();e?(x=s,L()):(x=x.concat(s),L()),j+=P,(r=document.getElementById("purchase-search"))==null||r.addEventListener("input",L)}function M(){E(!1)}async function k(){B=await(await fetch(`${l}/api/admin/users`,{credentials:"include"})).json(),T(),window.addEventListener("DOMContentLoaded",()=>{var r,a;let s=document.getElementById("darkmode-toggle");s&&(s.onclick=()=>{toggleDarkMode();let t=document.getElementById("darkmode-icon-path");document.documentElement.classList.contains("dark")?t.setAttribute("d","M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"):t.setAttribute("d","M12 3v1m0 16v1m8.66-13.66l-.71.71M4.05 19.95l-.71.71M21 12h-1M4 12H3m16.66 5.66l-.71-.71M4.05 4.05l-.71-.71M16 12a4 4 0 11-8 0 4 4 0 018 0z")}),(r=document.getElementById("user-search"))==null||r.addEventListener("input",T),(a=document.getElementById("export-users"))==null||a.addEventListener("click",J)})}async function Y(e,n){let s=null,t=(await(await fetch(`${l}/api/admin/users`,{credentials:"include"})).json()).find(i=>i.id===e);t&&(s={...t});let o=prompt("Neuer Name:",n);if(o&&o.trim()!==""){m(!0);let i=await p(),u=await fetch(`${l}/api/admin/users/${e}`,{method:"PUT",headers:{"Content-Type":"application/json","x-csrf-token":i},credentials:"include",body:JSON.stringify({name:o.trim()})});if(m(!1),!u.ok){g("Fehler beim Speichern des Namens","error");return}g("Benutzername ge\xE4ndert.","success",5e3,async()=>{if(!s)return;m(!0);let c=await p();await fetch(`${l}/api/admin/users/${e}`,{method:"PUT",headers:{"Content-Type":"application/json","x-csrf-token":c},credentials:"include",body:JSON.stringify({name:s.name})}),m(!1),g("Namens\xE4nderung r\xFCckg\xE4ngig gemacht!","success"),k()})}let d=prompt("Neues Passwort (mind. 6 Zeichen, leer lassen zum \xDCberspringen):");if(d){if(d.length<6)return g("Passwort zu kurz.","error");m(!0);let i=await p(),u=await fetch(`${l}/api/admin/users/${e}/password`,{method:"PUT",headers:{"Content-Type":"application/json","x-csrf-token":i},credentials:"include",body:JSON.stringify({password:d})});if(m(!1),!u.ok){g("Fehler beim \xC4ndern des Passworts","error");return}g("Passwort ge\xE4ndert.","success",5e3,async()=>{alert("Das alte Passwort kann aus Sicherheitsgr\xFCnden nicht wiederhergestellt werden.")})}else g("Benutzerdaten gespeichert!","success");k()}async function C(){let n=await(await fetch(`${l}/api/admin/users`,{credentials:"include"})).json(),s=document.getElementById("balance-control-list");s.innerHTML=n.map(a=>{let t=a.balance<0?"text-red-600 dark:text-red-400 font-bold":"text-green-600 dark:text-green-400 font-bold";return`<li class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-xl p-3 shadow-sm mb-2">
      <span class="flex-1 font-semibold">${a.name}: <span class="${t}">${a.balance.toFixed(2)} \u20AC</span></span>
      <div class="flex gap-2 mt-2 sm:mt-0">
        <input type="number" id="bal-${a.id}" class="w-20 border px-2 py-1 rounded" step="0.01" />
        <button class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 flex items-center gap-1 text-xs balance-add-btn" data-id="${a.id}" title="Guthaben erh\xF6hen">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 4v16m8-8H4' /></svg>
        </button>
        <button class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 flex items-center gap-1 text-xs balance-sub-btn" data-id="${a.id}" title="Guthaben verringern">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M20 12H4' /></svg>
        </button>
      </div>
    </li>`}).join(""),s.onclick=function(a){let t=a.target.closest(".balance-add-btn");if(t){r(t.dataset.id,"add");return}let o=a.target.closest(".balance-sub-btn");if(o){r(o.dataset.id,"subtract");return}};async function r(a,t){let o=parseFloat(document.getElementById("bal-"+a).value);if(isNaN(o))return g("Ung\xFCltiger Betrag.","error");m(!0);let u=(await(await fetch(`${l}/api/admin/users/${a}`,{credentials:"include"})).json()).balance;t==="add"?u+=o:u-=o;let c=await p();await fetch(`${l}/api/admin/users/${a}`,{method:"PUT",headers:{"Content-Type":"application/json","x-csrf-token":c},credentials:"include",body:JSON.stringify({balance:u})}),m(!1),g("Guthaben aktualisiert.","success"),C(),w()}}async function ee(){let n=await(await fetch(`${l}/api/admin/users`,{credentials:"include"})).json(),s=document.getElementById("buy-user");s&&(s.innerHTML=n.map(r=>`<option value="${r.id}">${r.name}</option>`).join(""))}var $=[];function O(e){let n=document.getElementById("buy-product-list");n&&(n.innerHTML="",e.forEach(s=>{let r=document.createElement("div");r.className="border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-xl p-4 shadow flex flex-col items-center",r.innerHTML=`
      ${s.image_url?`<img src="${s.image_url}" alt="${s.name}" class="w-20 h-20 object-contain mb-2 rounded shadow">`:""}
      <div class="font-semibold text-center mb-1">${s.name}</div>
      <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">${s.price.toFixed(2)} \u20AC</div>
      <div class="text-xs text-gray-500 mb-2">Bestand: ${s.stock}</div>
      <div class="flex gap-1 items-center mb-2">
        <input type="number" min="1" max="${s.stock}" value="1" class="buy-qty-input p-1 border rounded w-14 text-center" aria-label="Menge" />
      </div>
      <button class="buy-for-user-btn btn-main bg-blue-600 text-white px-3 py-1 rounded shadow hover:bg-blue-700 w-full" data-product-id="${s.id}" ${s.stock<1?"disabled":""}>Kaufen</button>
    `,n.appendChild(r)}))}async function _(){$=(await(await fetch(`${l}/api/admin/products`,{credentials:"include"})).json()).filter(s=>s.available&&s.stock>0),O($)}function te(){var s,r;let e=((r=(s=document.getElementById("buy-product-search"))==null?void 0:s.value)==null?void 0:r.toLowerCase())||"",n=$.filter(a=>a.name.toLowerCase().includes(e)||a.category&&a.category.toLowerCase().includes(e));O(n)}async function ne(e,n){var i;let s=document.getElementById("buy-user"),r=s==null?void 0:s.value;if(!r||!e||isNaN(n)||n<=0)return;let a=await p(),t=await fetch(`${l}/api/admin/buy`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":a},credentials:"include",body:JSON.stringify({user_id:r,product_id:e,quantity:n})}),o=await t.json(),d=document.getElementById("buy-for-user-result");if(t.ok){let u=((i=s.options[s.selectedIndex])==null?void 0:i.textContent)||"";d.textContent="",g(`Kauf f\xFCr ${u} erfolgreich!`,"success",3500),document.getElementById("buy-product-search").value="",document.querySelectorAll(".buy-qty-input").forEach(c=>c.value=1),w(),b(),C(),_()}else d.textContent=o.error||"Fehler",g(o.error||"Fehler beim Kauf","error",4e3)}window.addEventListener("DOMContentLoaded",()=>{var e,n,s;G(),w(),b(),E(!0),k(),C(),ee(),_(),(e=document.getElementById("export-purchases"))==null||e.addEventListener("click",R),(n=document.getElementById("buy-product-search"))==null||n.addEventListener("input",te),(s=document.getElementById("buy-product-list"))==null||s.addEventListener("click",function(r){if(r.target.classList.contains("buy-for-user-btn")){let a=r.target.closest("div"),t=r.target.getAttribute("data-product-id"),o=a.querySelector(".buy-qty-input"),d=parseInt(o.value||"1");ne(t,d)}}),typeof startSessionCheck=="function"&&startSessionCheck()});window.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("faq-btn"),n=document.getElementById("faq-overlay"),s=document.getElementById("faq-close");e&&n&&s&&(e.addEventListener("click",()=>{n.classList.remove("hidden"),s.focus()}),s.addEventListener("click",()=>{n.classList.add("hidden"),e.focus()}),n.addEventListener("click",c=>{c.target===n&&(n.classList.add("hidden"),e.focus())}),document.addEventListener("keydown",c=>{!n.classList.contains("hidden")&&(c.key==="Escape"||c.key==="Esc")&&(n.classList.add("hidden"),e.focus())}));let r=document.getElementById("darkModeBtn");r&&r.addEventListener("click",()=>{let c=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",c?"true":"false")}),localStorage.getItem("darkMode")===null?(document.documentElement.classList.add("dark"),localStorage.setItem("darkMode","true")):localStorage.getItem("darkMode")!=="false"?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");let a=document.querySelectorAll("#admin-tabs button[data-tab]"),t=document.querySelectorAll(".tab-content");function o(c){t.forEach(function(f){f.id==="section-"+c?f.style.display="":f.style.display="none"}),a.forEach(function(f){f.classList.toggle("ring-2",f.dataset.tab===c)})}a.forEach(function(c){c.addEventListener("click",function(){o(c.dataset.tab)})}),o("products");let d=document.getElementById("logoutBtn");d&&d.addEventListener("click",()=>{fetch("/api/logout",{method:"POST",credentials:"include"}).finally(()=>{sessionStorage.clear(),window.location.href="/index.html"})});let i;function u(){clearTimeout(i),i=setTimeout(()=>{alert("Session abgelaufen. Du wirst abgemeldet."),fetch("/api/logout",{method:"POST",credentials:"include"}).finally(()=>{sessionStorage.clear(),window.location.href="/index.html"})},1200*1e3)}["click","keydown","mousemove","touchstart"].forEach(c=>{window.addEventListener(c,u)}),u()});})();
