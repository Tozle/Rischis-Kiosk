(()=>{var n=o=>document.getElementById(o);document.addEventListener("DOMContentLoaded",()=>{let o=n("profile-message");if(!o){o=document.createElement("div"),o.id="profile-message",o.className="mb-2 text-center text-sm";let e=n("profile-choice");e&&e.parentNode&&e.parentNode.insertBefore(o,e.nextSibling)}let p=n("profile-btn"),g=n("profile-modal"),v=n("profile-close"),l=n("profile-image-form"),h=n("profile-image-url"),a=n("profile-image-preview"),u=n("profile-image-error"),x=n("profile-image-message"),d=n("profile-name-form"),w=n("profile-username"),m=n("profile-name-message"),f=n("profile-password-form"),L=n("profile-password"),b=n("profile-password-repeat"),c=n("profile-password-message");if(!p||!g)return;g.style.display="none";let C=null;fetch("/api/auth/me",{credentials:"include"}).then(e=>e.json()).then(e=>{var t,s,i,r;if(e!=null&&e.loggedIn){C=e.user,S((t=e.user)==null?void 0:t.profile_image_url);try{localStorage.setItem("user_profile",JSON.stringify({name:((s=e.user)==null?void 0:s.name)||"",image:((i=e.user)==null?void 0:i.profile_image_url)||""}))}catch(E){}let y=n("admin-btn");y&&(((r=e.user)==null?void 0:r.role)==="admin"?y.classList.remove("hidden"):y.classList.add("hidden"))}g&&(g.style.display="")});function S(e){if(p)if(p.innerHTML="",e){let t=document.createElement("img");t.src=e,t.alt="Profilbild",t.style.width="100%",t.style.height="100%",t.style.objectFit="cover",t.style.borderRadius="9999px",p.appendChild(t)}else{let t=document.createElement("span");t.innerHTML="<svg xmlns='http://www.w3.org/2000/svg' class='w-7 h-7' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z' /></svg>",p.appendChild(t)}}p.addEventListener("click",async()=>{let e=C;if(!e)try{let r=await(await fetch("/api/auth/me",{credentials:"include"})).json();r!=null&&r.loggedIn&&(e=r.user)}catch(i){}if(!e){alert("Bitte zuerst einloggen, um die Profileinstellungen zu \xF6ffnen.");return}w&&(w.value=(e==null?void 0:e.name)||""),h&&(h.value=(e==null?void 0:e.profile_image_url)||"");let t=n("profile-balance");if(t){let i=e==null?void 0:e.balance;typeof i=="number"?(t.textContent=i.toFixed(2).replace(".",",")+" \u20AC",t.classList.toggle("text-red-600",i<0),t.classList.toggle("text-green-700",i>=0)):(t.textContent="\u2013",t.classList.remove("text-red-600","text-green-700"))}let s=n("profile-choice");s&&s.classList.remove("hidden"),l&&l.classList.add("hidden"),d&&d.classList.add("hidden"),f&&f.classList.add("hidden"),o&&(o.textContent=""),g.classList.remove("hidden")}),v&&v.addEventListener("click",()=>{g.classList.add("hidden"),o.textContent=""}),[["profile-choice-image",l],["profile-choice-name",d],["profile-choice-password",f]].forEach(([e,t])=>{let s=n(e);s&&t&&(s.onclick=()=>{n("profile-choice").classList.add("hidden"),[l,d,f].forEach(i=>i&&i.classList.add("hidden")),t.classList.remove("hidden"),o&&(o.textContent="")})}),[["profile-cancel-image",l],["profile-cancel-name",d],["profile-cancel-password",f]].forEach(([e,t])=>{let s=n(e);s&&t&&(s.onclick=()=>{t.classList.add("hidden"),n("profile-choice").classList.remove("hidden")})}),h&&a&&u&&(h.addEventListener("input",()=>{let e=h.value.trim();if(!e){a.src="",a.classList.add("hidden"),u.textContent="";return}a.src=e,a.classList.remove("hidden"),u.textContent=""}),a.onerror=()=>{a.classList.add("hidden"),u.textContent="Bild konnte nicht geladen werden."},a.onload=()=>{u.textContent="",a.classList.remove("hidden")}),l&&l.addEventListener("submit",async e=>{e.preventDefault();let t=h.value.trim();if(!t){u.textContent="Bitte gib eine Bild-URL ein.";return}try{let s=await fetch("/api/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({profile_image_url:t})}),i=await s.json();if(!s.ok)throw new Error(i.error||"Fehler beim Speichern");x.textContent="Profilbild gespeichert!",x.className="text-green-600",S(t);try{let r=JSON.parse(localStorage.getItem("user_profile")||"{}");r.image=t,localStorage.setItem("user_profile",JSON.stringify(r))}catch(r){}setTimeout(()=>{x.textContent=""},2e3)}catch(s){x.textContent=s.message||"Fehler beim Speichern",x.className="text-red-500"}}),d&&d.addEventListener("submit",async e=>{e.preventDefault();let t=w.value.trim();if(!t){m.textContent="Bitte gib einen Benutzernamen ein.",m.className="text-red-500";return}try{let s=await fetch("/api/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({name:t})}),i=await s.json();if(!s.ok)throw new Error(i.error||"Fehler beim Speichern");m.textContent="Name gespeichert!",m.className="text-green-600";try{let r=JSON.parse(localStorage.getItem("user_profile")||"{}");r.name=t,localStorage.setItem("user_profile",JSON.stringify(r))}catch(r){}setTimeout(()=>{m.textContent=""},2e3)}catch(s){m.textContent=s.message||"Fehler beim Speichern",m.className="text-red-500"}}),f&&f.addEventListener("submit",async e=>{e.preventDefault();let t=L.value,s=b.value;if(!t){c.textContent="Bitte gib ein Passwort ein.",c.className="text-red-500";return}if(t!==s){c.textContent="Passw\xF6rter stimmen nicht \xFCberein.",c.className="text-red-500";return}try{let i=await fetch("/api/auth/profile",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({password:t})}),r=await i.json();if(!i.ok)throw new Error(r.error||"Fehler beim Speichern");c.textContent="Passwort gespeichert!",c.className="text-green-600",L.value="",b.value="",setTimeout(()=>{c.textContent=""},2e3)}catch(i){c.textContent=i.message||"Fehler beim Speichern",c.className="text-red-500"}})});})();
