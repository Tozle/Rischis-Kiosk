(()=>{function L(){let n=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",n?"true":"false")}localStorage.getItem("darkMode")!=="false"&&document.documentElement.classList.add("dark");document.addEventListener("DOMContentLoaded",()=>{let n=document.getElementById("darkmode-toggle-btn");n&&n.addEventListener("click",L)});var f=window.location.origin,$=null,h=0,b=!1,E=[];function p(n,e="info"){let t=document.getElementById("toast");t&&(t.textContent=n,t.className=`fixed left-1/2 top-6 z-50 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-center text-sm font-semibold transition-opacity duration-300 pointer-events-none ${e==="error"?"bg-red-600":"bg-green-600"} text-white opacity-100`,setTimeout(()=>{t.classList.add("opacity-0")},4e3))}async function B(){try{let e=await(await fetch(`${f}/api/user`,{credentials:"include"})).json();if(!(e!=null&&e.id))throw new Error("Keine Nutzerdaten erhalten");$=e,h=e.balance||0,document.getElementById("user-email").textContent=e.email;let t=document.getElementById("user-balance");t.textContent=`${h.toFixed(2)} \u20AC`,t.className=h<0?"text-red-600 dark:text-red-400 font-bold":"text-green-600 dark:text-green-400 font-bold"}catch(n){console.error(n),p("Fehler beim Laden des Nutzers","error")}finally{}}async function w(){var n;try{let e=((n=document.getElementById("sort-products"))==null?void 0:n.value)||"price_asc",r=fetch(`${f}/api/products?sort=${e==="recent"?"price_asc":e}`),o=e==="recent"||!b,c=o?fetch(`${f}/api/purchases?sort=desc${e==="recent"?"":"&limit=3"}`,{credentials:"include"}):null,[i,u]=await Promise.all([r,c]),l=await i.json(),m=u?await u.json():[],s=[];m.forEach(d=>{s.includes(d.product_id)||s.push(d.product_id)}),o&&s.length&&(l.forEach(d=>{s.includes(d.id)&&(d.recent=!0)}),l.sort((d,v)=>{let g=s.indexOf(d.id),y=s.indexOf(v.id);return g!==-1&&y!==-1?g-y:g!==-1?-1:y!==-1?1:0})),E=l,I(l),x()}catch(e){console.error(e),p("Fehler beim Laden der Produkte","error")}finally{}}function I(n){let e=document.getElementById("category-filter");if(!e)return;let t=e.value,r=[...new Set(n.map(o=>o.category).filter(Boolean))];e.innerHTML='<option value="">Alle Kategorien</option>',r.forEach(o=>{let a=document.createElement("option");a.value=o,a.textContent=o,e.appendChild(a)}),t&&(e.value=t)}function x(){var r,o;let n=((r=document.getElementById("search"))==null?void 0:r.value.toLowerCase())||"",e=((o=document.getElementById("category-filter"))==null?void 0:o.value)||"",t=E.filter(a=>{let c=!e||a.category===e,i=!n||a.name.toLowerCase().includes(n);return c&&i});C(t)}function C(n){let e=document.getElementById("product-list");e.innerHTML="",n.forEach(t=>{let r=document.createElement("li");r.className="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 p-4 rounded-xl shadow-md hover:shadow-lg transition text-gray-800 dark:text-white",t.recent&&(r.className+=" border-yellow-400");let o=t.image_url&&t.image_url.trim()!=="";r.innerHTML=`
      <div class="flex flex-col sm:flex-row sm:items-center gap-4">
        ${o?`<img src="${t.image_url}" alt="${t.name}" class="w-28 h-28 sm:w-32 sm:h-32 object-contain rounded-xl shadow border border-gray-200 dark:border-gray-700 bg-white flex-shrink-0 mx-auto sm:mx-0" loading="lazy">`:""}
        <div class="flex-1 flex flex-col justify-between h-full w-full">
          <div>
            <p class="text-lg font-bold mb-1">${t.name}</p>
            ${t.recent?'<p class="text-xs text-yellow-600 dark:text-yellow-400 mb-1">Zuletzt gekauft</p>':""}
            <p class="text-base text-gray-600 dark:text-gray-300 mb-2">${t.price.toFixed(2)} \u20AC <span class="mx-1">\xB7</span> <span class="text-xs">Bestand: ${t.stock}</span></p>
          </div>
          <div class="mt-2 w-full">
            ${t.stock>0?`<div class="flex flex-col xs:flex-row items-stretch xs:items-center gap-2 mt-2 w-full">
                  <div class='flex flex-row items-center gap-2 justify-center xs:justify-start'>
                    <button type="button" aria-label="Weniger" class="bg-gray-200 dark:bg-gray-600 text-lg px-3 py-2 rounded-full font-bold focus:ring-2 focus:ring-cyan-400" onclick="changeQty('${t.id}', -1, ${t.stock})">-</button>
                    <span id="qty-display-${t.id}" class="inline-block w-10 text-center select-none font-semibold text-lg">1</span>
                    <button type="button" aria-label="Mehr" class="bg-gray-200 dark:bg-gray-600 text-lg px-3 py-2 rounded-full font-bold focus:ring-2 focus:ring-cyan-400" onclick="changeQty('${t.id}', 1, ${t.stock})">+</button>
                  </div>
                  <button class="btn-main w-full xs:w-auto px-5 py-2 text-base" style="min-width: 100px;" onclick="buyProduct('${t.id}', 'qty-display-${t.id}', '${t.name}', ${t.price})">Kaufen</button>
                </div>`:'<span class="text-red-500 font-semibold">Ausverkauft</span>'}
          </div>
        </div>
      </div>
    `,e.appendChild(r)})}async function k(){var n;try{let e=((n=document.getElementById("sort-history"))==null?void 0:n.value)||"desc",r=await(await fetch(`${f}/api/purchases?sort=${e}`,{credentials:"include"})).json();if(!Array.isArray(r))throw new Error("Ung\xFCltige Antwort");let o=document.getElementById("purchase-history");o.innerHTML="",r.forEach(a=>{let c=document.createElement("li"),i=new Date(a.created_at).toLocaleString("de-DE",{timeZone:"Europe/Berlin"});c.textContent=`${i}: ${a.quantity||1}x ${a.product_name} \u2013 ${a.price.toFixed(2)} \u20AC`,o.appendChild(c)})}catch(e){console.error(e),p("Fehler beim Laden des Kaufverlaufs","error")}finally{}}document.addEventListener("DOMContentLoaded",async()=>{var i,u,l,m;await B(),await w(),await k(),typeof startSessionCheck=="function"&&startSessionCheck(),(i=document.getElementById("sort-history"))==null||i.addEventListener("change",k),(u=document.getElementById("sort-products"))==null||u.addEventListener("change",()=>{b=!0,w()}),(l=document.getElementById("search"))==null||l.addEventListener("input",x),(m=document.getElementById("category-filter"))==null||m.addEventListener("change",x);let n=document.getElementById("faq-btn"),e=document.getElementById("faq-overlay"),t=document.getElementById("faq-close");n&&e&&t&&(n.addEventListener("click",()=>{e.classList.remove("hidden"),t.focus()}),t.addEventListener("click",()=>{e.classList.add("hidden"),n.focus()}),e.addEventListener("click",s=>{s.target===e&&(e.classList.add("hidden"),n.focus())}),document.addEventListener("keydown",s=>{!e.classList.contains("hidden")&&(s.key==="Escape"||s.key==="Esc")&&(e.classList.add("hidden"),n.focus())}));let r=document.getElementById("darkModeBtn");r&&r.addEventListener("click",()=>{let s=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",s?"true":"false")}),localStorage.getItem("darkMode")===null?(document.documentElement.classList.add("dark"),localStorage.setItem("darkMode","true")):localStorage.getItem("darkMode")!=="false"?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");let o=document.getElementById("logoutBtn");o&&o.addEventListener("click",()=>{fetch("/api/logout",{method:"POST",credentials:"include"}).finally(()=>{sessionStorage.clear(),window.location.href="/index.html"})});let a;function c(){clearTimeout(a),a=setTimeout(()=>{alert("Session abgelaufen. Du wirst abgemeldet."),fetch("/api/logout",{method:"POST",credentials:"include"}).finally(()=>{sessionStorage.clear(),window.location.href="/index.html"})},1200*1e3)}["click","keydown","mousemove","touchstart"].forEach(s=>{window.addEventListener(s,c)}),c()});})();
