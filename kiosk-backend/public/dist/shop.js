(()=>{function $(){let a=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",a?"true":"false")}localStorage.getItem("darkMode")!=="false"&&document.documentElement.classList.add("dark");document.addEventListener("DOMContentLoaded",()=>{let a=document.getElementById("darkmode-toggle-btn");a&&a.addEventListener("click",$)});var g=window.location.origin,I=null,x=0,E=!1,v=[];async function C(){try{return(await(await fetch(`${g}/api/csrf-token`,{credentials:"include"})).json()).csrfToken}catch(a){return console.error("CSRF-Token konnte nicht geladen werden",a),null}}function f(a,e="info"){let t=document.getElementById("toast");if(!t)return;let o="";e==="success"?o="<svg class='inline w-5 h-5 mr-2 -mt-1 text-white' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 13l4 4L19 7' /></svg>":e==="error"&&(o="<svg class='inline w-5 h-5 mr-2 -mt-1 text-white' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12' /></svg>"),t.innerHTML=o+a,t.className=`fixed left-1/2 top-6 z-50 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-center text-base font-semibold transition-opacity duration-300 pointer-events-none ${e==="error"?"bg-red-600":"bg-green-600"} text-white opacity-100`,setTimeout(()=>{t.classList.add("opacity-0")},3500)}async function L(){try{let e=await(await fetch(`${g}/api/user`,{credentials:"include"})).json();if(!(e!=null&&e.id))throw new Error("Keine Nutzerdaten erhalten");I=e,x=e.balance||0,document.getElementById("user-email").textContent=e.email;let t=document.getElementById("user-balance");t.textContent=`${x.toFixed(2)} \u20AC`,t.className=x<0?"text-red-600 dark:text-red-400 font-bold":"text-green-600 dark:text-green-400 font-bold"}catch(a){console.error(a),f("Fehler beim Laden des Nutzers","error")}finally{}}async function p(){var a;try{let e=((a=document.getElementById("sort-products"))==null?void 0:a.value)||"price_asc",o=fetch(`${g}/api/products?sort=${e==="recent"?"price_asc":e}`),n=e==="recent"||!E,r=n?fetch(`${g}/api/purchases?sort=desc${e==="recent"?"":"&limit=3"}`,{credentials:"include"}):null,[c,d]=await Promise.all([o,r]),l=await c.json(),m=d?await d.json():[],i=[];m.forEach(u=>{i.includes(u.product_id)||i.push(u.product_id)}),n&&i.length&&(l.forEach(u=>{i.includes(u.id)&&(u.recent=!0)}),l.sort((u,B)=>{let y=i.indexOf(u.id),h=i.indexOf(B.id);return y!==-1&&h!==-1?y-h:y!==-1?-1:h!==-1?1:0})),v=l,S(l),b()}catch(e){console.error(e),f("Fehler beim Laden der Produkte","error")}finally{}}function S(a){let e=document.getElementById("category-filter");if(!e)return;let t=e.value,o=[...new Set(a.map(n=>n.category).filter(Boolean))];e.innerHTML='<option value="">Alle Kategorien</option>',o.forEach(n=>{let s=document.createElement("option");s.value=n,s.textContent=n,e.appendChild(s)}),t&&(e.value=t)}function b(){var o,n;let a=((o=document.getElementById("search"))==null?void 0:o.value.toLowerCase())||"",e=((n=document.getElementById("category-filter"))==null?void 0:n.value)||"",t=v.filter(s=>{let r=!e||s.category===e,c=!a||s.name.toLowerCase().includes(a);return r&&c});M(t)}function M(a){let e=document.getElementById("product-list");e.innerHTML="",a.forEach(t=>{let o=document.createElement("li");o.className="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 p-4 rounded-xl shadow-md hover:shadow-lg transition text-gray-800 dark:text-white",t.recent&&(o.className+=" border-yellow-400");let n=t.image_url&&t.image_url.trim()!=="";o.innerHTML=`
      <div class="flex flex-col sm:flex-row sm:items-center gap-4">
        ${n?`<img src="${t.image_url}" alt="${t.name}" class="w-28 h-28 sm:w-32 sm:h-32 object-contain rounded-xl shadow border border-gray-200 dark:border-gray-700 bg-white flex-shrink-0 mx-auto sm:mx-0" loading="lazy">`:""}
        <div class="flex-1 flex flex-col justify-between h-full w-full">
          <div>
            <p class="text-lg font-bold mb-1">${t.name}</p>
            ${t.recent?'<p class="text-xs text-yellow-600 dark:text-yellow-400 mb-1">Zuletzt gekauft</p>':""}
            <p class="text-base text-gray-600 dark:text-gray-300 mb-2">${t.price.toFixed(2)} \u20AC <span class="mx-1">\xB7</span> <span class="text-xs">Bestand: ${t.stock}</span></p>
          </div>
          <div class="mt-2 w-full">
            ${t.stock>0?`<div class="flex flex-col xs:flex-row items-stretch xs:items-center gap-2 mt-2 w-full">
                  <div class='flex flex-row items-center gap-2 justify-center xs:justify-start'>
                    <button type="button" aria-label="Weniger" class="bg-gray-200 dark:bg-gray-600 text-lg px-3 py-2 rounded-full font-bold focus:ring-2 focus:ring-cyan-400 qty-minus-btn" data-id="${t.id}" data-max="${t.stock}">-</button>
                    <span id="qty-display-${t.id}" class="inline-block w-10 text-center select-none font-semibold text-lg">1</span>
                    <button type="button" aria-label="Mehr" class="bg-gray-200 dark:bg-gray-600 text-lg px-3 py-2 rounded-full font-bold focus:ring-2 focus:ring-cyan-400 qty-plus-btn" data-id="${t.id}" data-max="${t.stock}">+</button>
                  </div>
                  <button class="btn-main w-full xs:w-auto px-5 py-2 text-base buy-btn" style="min-width: 100px;" data-id="${t.id}" data-name="${t.name}" data-price="${t.price}">Kaufen</button>
                </div>`:'<span class="text-red-500 font-semibold">Ausverkauft</span>'}
          </div>
        </div>
      </div>
    `,e.appendChild(o)}),e.onclick=function(t){let o=t.target.closest(".qty-minus-btn");if(o){k(o.dataset.id,-1,parseInt(o.dataset.max));return}let n=t.target.closest(".qty-plus-btn");if(n){k(n.dataset.id,1,parseInt(n.dataset.max));return}let s=t.target.closest(".buy-btn");if(s){T(s.dataset.id,`qty-display-${s.dataset.id}`,s.dataset.name,parseFloat(s.dataset.price));return}}}async function w(){var a;try{let e=((a=document.getElementById("sort-history"))==null?void 0:a.value)||"desc",o=await(await fetch(`${g}/api/purchases?sort=${e}`,{credentials:"include"})).json();if(!Array.isArray(o))throw new Error("Ung\xFCltige Antwort");let n=document.getElementById("purchase-history");n.innerHTML="",o.forEach(s=>{let r=document.createElement("li"),c=new Date(s.created_at).toLocaleString("de-DE",{timeZone:"Europe/Berlin"});r.textContent=`${c}: ${s.quantity||1}x ${s.product_name} \u2013 ${s.price.toFixed(2)} \u20AC`,n.appendChild(r)})}catch(e){console.error(e),f("Fehler beim Laden des Kaufverlaufs","error")}finally{}}async function T(a,e,t,o){var c;let n=parseInt(((c=document.getElementById(e))==null?void 0:c.textContent)||"1");if(!Number.isInteger(n)||n<=0)return f("Ung\xFCltige Menge","error");let s=`M\xF6chtest du wirklich ${n}x ${t} f\xFCr ${(o*n).toFixed(2)} \u20AC kaufen?`;if(!confirm(s))return;let r=document.querySelector(`.buy-btn[data-id="${a}"]`);r&&(r.disabled=!0,r.textContent="...");try{let d=await C(),l=await fetch(`${g}/api/buy`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":d},credentials:"include",body:JSON.stringify({product_id:a,quantity:n})}),m=await l.json();if(!l.ok)throw new Error(m.error||"Unbekannter Fehler");let i=(o*n).toFixed(2);f(`Erfolgreich ${n}x ${t} f\xFCr ${i} \u20AC gekauft!`,"success"),r&&(r.textContent="Gekauft!",r.classList.add("bg-green-700"),setTimeout(()=>{r.textContent="Kaufen",r.classList.remove("bg-green-700"),r.disabled=!1},1200));let u=document.getElementById(e);u&&(u.textContent="1"),await L(),await p(),await w()}catch(d){console.error(d),f(d.message||"Fehler beim Kauf","error"),r&&(r.textContent="Kaufen",r.disabled=!1)}}function k(a,e,t){let o=document.getElementById(`qty-display-${a}`);if(!o)return;let n=parseInt(o.textContent||"1");n+=e,n<1&&(n=1),n>t&&(n=t),o.textContent=n}document.addEventListener("DOMContentLoaded",async()=>{var c,d,l,m;await L(),await p(),await w(),typeof startSessionCheck=="function"&&startSessionCheck(),(c=document.getElementById("sort-history"))==null||c.addEventListener("change",w),(d=document.getElementById("sort-products"))==null||d.addEventListener("change",()=>{E=!0,p()}),(l=document.getElementById("search"))==null||l.addEventListener("input",b),(m=document.getElementById("category-filter"))==null||m.addEventListener("change",b);let a=document.getElementById("faq-btn"),e=document.getElementById("faq-overlay"),t=document.getElementById("faq-close");a&&e&&t&&(a.addEventListener("click",()=>{e.classList.remove("hidden"),t.focus()}),t.addEventListener("click",()=>{e.classList.add("hidden"),a.focus()}),e.addEventListener("click",i=>{i.target===e&&(e.classList.add("hidden"),a.focus())}),document.addEventListener("keydown",i=>{!e.classList.contains("hidden")&&(i.key==="Escape"||i.key==="Esc")&&(e.classList.add("hidden"),a.focus())}));let o=document.getElementById("darkModeBtn");o&&o.addEventListener("click",()=>{let i=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",i?"true":"false")}),localStorage.getItem("darkMode")===null?(document.documentElement.classList.add("dark"),localStorage.setItem("darkMode","true")):localStorage.getItem("darkMode")!=="false"?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");let n=document.getElementById("logoutBtn");n&&n.addEventListener("click",()=>{fetch("/api/logout",{method:"POST",credentials:"include"}).finally(()=>{sessionStorage.clear(),window.location.href="/index.html"})});let s;function r(){clearTimeout(s),s=setTimeout(()=>{alert("Session abgelaufen. Du wirst abgemeldet."),fetch("/api/logout",{method:"POST",credentials:"include"}).finally(()=>{sessionStorage.clear(),window.location.href="/index.html"})},1200*1e3)}["click","keydown","mousemove","touchstart"].forEach(i=>{window.addEventListener(i,r)}),r()});})();
