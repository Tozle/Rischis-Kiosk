(()=>{var b=n=>document.getElementById(n);async function $(){try{return(await(await fetch(`${window.location.origin}/api/csrf-token`,{credentials:"include"})).json()).csrfToken}catch(n){return console.error("CSRF-Token konnte nicht geladen werden",n),null}}function f(n,t=!1){let e=document.getElementById("message");e&&(e.textContent=n,e.className=t?"text-green-600 mt-4 text-center":"text-red-500 mt-4 text-center",e.classList.remove("hidden"),setTimeout(()=>e.classList.add("hidden"),5e3))}var y=window.location.origin,q=null,w=0,B=!1,C=[];async function I(){try{let t=await(await fetch(`${y}/api/user`,{credentials:"include"})).json();if(!(t!=null&&t.id))throw new Error("Keine Nutzerdaten erhalten");q=t,w=t.balance||0,b("user-email").textContent=t.email;let e=b("user-balance");e.textContent=`${w.toFixed(2)} \u20AC`,e.className=w<0?"text-red-600 font-bold":"text-green-600 font-bold"}catch(n){console.error(n),f("Fehler beim Laden des Nutzers","error")}}async function E(){var e;let n=document.getElementById("product-list-loading"),t=document.getElementById("product-list");n&&n.classList.remove("hidden"),t&&t.classList.add("opacity-30","pointer-events-none");try{let o=((e=document.getElementById("sort-products"))==null?void 0:e.value)||"price_asc",r=fetch(`${y}/api/products?sort=${o==="recent"?"price_asc":o}`),a=o==="recent"||!B,d=a?fetch(`${y}/api/purchases?sort=desc${o==="recent"?"":"&limit=3"}`,{credentials:"include"}):null,[l,c]=await Promise.all([r,d]),m=await l.json(),h=c?await c.json():[],g=[];h.forEach(u=>{g.includes(u.product_id)||g.push(u.product_id)}),a&&g.length&&(m.forEach(u=>{g.includes(u.id)&&(u.recent=!0)}),m.sort((u,T)=>{let p=g.indexOf(u.id),x=g.indexOf(T.id);return p!==-1&&x!==-1?p-x:p!==-1?-1:x!==-1?1:0})),C=m,S(m),v()}catch(o){console.error(o),f("Fehler beim Laden der Produkte","error")}finally{n&&n.classList.add("hidden"),t&&t.classList.remove("opacity-30","pointer-events-none")}}function S(n){let t=document.getElementById("category-filter");if(!t)return;let e=t.value,o=[...new Set(n.map(s=>s.category).filter(Boolean))];t.innerHTML='<option value="">Alle Kategorien</option>',o.forEach(s=>{let r=document.createElement("option");r.value=s,r.textContent=s,t.appendChild(r)}),e&&(t.value=e)}function v(){var o,s;let n=((o=document.getElementById("search"))==null?void 0:o.value.toLowerCase())||"",t=((s=document.getElementById("category-filter"))==null?void 0:s.value)||"",e=C.filter(r=>{let a=!t||r.category===t,i=!n||r.name.toLowerCase().includes(n);return a&&i});j(e)}function j(n){let t=document.getElementById("product-list");t.innerHTML="",n.forEach(e=>{let o=document.createElement("li");o.className=["border","border-cyan-900","bg-gray-800/90","backdrop-blur-md","p-4","rounded-2xl","shadow-lg","hover:shadow-xl","transition","text-cyan-100","relative",e.recent?"border-yellow-400":""].join(" ");let s=e.image_url&&e.image_url.trim()!=="",r='<div class="w-28 h-28 sm:w-32 sm:h-32 flex items-center justify-center rounded-xl bg-cyan-950 border border-cyan-900 mx-auto sm:mx-0 p-2"><svg width="48" height="48" fill="none" stroke="#38bdf8" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="4"/><path d="M3 17l6-6a2 2 0 012.8 0l7.2 7"/></svg></div>';if(o.innerHTML=`
      <div class="flex flex-col sm:flex-row sm:items-center gap-4">
        <div class="shop-img-container">${r}</div>
        <div class="flex-1 flex flex-col justify-between h-full w-full">
          <div>
            <p class="text-lg font-bold mb-1">${e.name}</p>
            ${e.recent?'<p class="text-xs text-yellow-400 mb-1">Zuletzt gekauft</p>':""}
            <p class="text-base text-cyan-200 mb-2">${e.price.toFixed(2)} \u20AC <span class="mx-1">\xB7</span> <span class="text-xs">Bestand: ${e.stock}</span></p>
          </div>
          <div class="mt-2 w-full">
            ${e.stock>0?`<div class="flex flex-col xs:flex-row items-stretch xs:items-center gap-2 mt-2 w-full">
                  <div class='flex flex-row items-center gap-2 justify-center xs:justify-start'>
                    <button type="button" aria-label="Weniger" class="bg-cyan-100 text-cyan-900 text-lg px-3 py-2 rounded-full font-bold focus:ring-2 focus:ring-cyan-400 qty-minus-btn" data-id="${e.id}" data-max="${e.stock}">-</button>
                    <span id="qty-display-${e.id}" class="inline-block w-10 text-center select-none font-semibold text-lg">1</span>
                    <button type="button" aria-label="Mehr" class="bg-cyan-100 text-cyan-900 text-lg px-3 py-2 rounded-full font-bold focus:ring-2 focus:ring-cyan-400 qty-plus-btn" data-id="${e.id}" data-max="${e.stock}">+</button>
                  </div>
                  <button class="btn-main w-full xs:w-auto px-5 py-2 text-base buy-btn" style="min-width: 100px;" data-id="${e.id}" data-name="${e.name}" data-price="${e.price}">Kaufen</button>
                </div>`:'<span class="text-red-400 font-semibold">Ausverkauft</span>'}
          </div>
        </div>
      </div>
    `,t.appendChild(o),s){let a=new window.Image;a.src=e.image_url,a.alt=e.name,a.width=128,a.height=128,a.className=["w-24 h-24 sm:w-28 sm:h-28","object-contain","rounded-xl","shadow-md","border","border-gray-200/60","bg-white","p-2","mx-auto","sm:mx-0","block"].join(" "),a.style.background="#fff",a.onload=()=>{let i=o.querySelector(".shop-img-container");i&&(i.innerHTML=""),i&&i.appendChild(a)},a.onerror=()=>{}}}),t.onclick=function(e){let o=e.target.closest(".qty-minus-btn");if(o){k(o.dataset.id,-1,parseInt(o.dataset.max));return}let s=e.target.closest(".qty-plus-btn");if(s){k(s.dataset.id,1,parseInt(s.dataset.max));return}let r=e.target.closest(".buy-btn");if(r){M(r.dataset.id,`qty-display-${r.dataset.id}`,r.dataset.name,parseFloat(r.dataset.price));return}}}async function L(){var n;try{let t=((n=document.getElementById("sort-history"))==null?void 0:n.value)||"desc",o=await(await fetch(`${y}/api/purchases?sort=${t}`,{credentials:"include"})).json();if(!Array.isArray(o))throw new Error("Ung\xFCltige Antwort");let s=document.getElementById("purchase-history");s.innerHTML="",o.forEach(r=>{let a=document.createElement("li"),i=new Date(r.created_at).toLocaleString("de-DE",{timeZone:"Europe/Berlin"});a.textContent=`${i}: ${r.quantity||1}x ${r.product_name} \u2013 ${r.price.toFixed(2)} \u20AC`,s.appendChild(a)})}catch(t){console.error(t),f("Fehler beim Laden des Kaufverlaufs","error")}finally{}}async function M(n,t,e,o){var i;let s=parseInt(((i=document.getElementById(t))==null?void 0:i.textContent)||"1");if(!Number.isInteger(s)||s<=0)return f("Ung\xFCltige Menge","error");let r=`M\xF6chtest du wirklich ${s}x ${e} f\xFCr ${(o*s).toFixed(2)} \u20AC kaufen?`;if(!confirm(r))return;let a=document.querySelector(`.buy-btn[data-id="${n}"]`);a&&(a.disabled=!0,a.textContent="...");try{let d=await $(),l=await fetch(`${y}/api/buy`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":d},credentials:"include",body:JSON.stringify({product_id:n,quantity:s})}),c=await l.json();if(!l.ok)throw new Error(c.error||"Unbekannter Fehler");let m=(o*s).toFixed(2);f(`Erfolgreich ${s}x ${e} f\xFCr ${m} \u20AC gekauft!`,"success"),a&&(a.textContent="Gekauft!",a.classList.add("bg-green-700"),setTimeout(()=>{a.textContent="Kaufen",a.classList.remove("bg-green-700"),a.disabled=!1},1200));let h=document.getElementById(t);h&&(h.textContent="1"),await I(),await E(),await L()}catch(d){console.error(d),f(d.message||"Fehler beim Kauf","error"),a&&(a.textContent="Kaufen",a.disabled=!1)}}function k(n,t,e){let o=document.getElementById(`qty-display-${n}`);if(!o)return;let s=parseInt(o.textContent||"1");s+=t,s<1&&(s=1),s>e&&(s=e),o.textContent=s}document.addEventListener("DOMContentLoaded",async()=>{var a,i,d,l;await I(),await E(),await L(),typeof startSessionCheck=="function"&&startSessionCheck(),(a=document.getElementById("sort-history"))==null||a.addEventListener("change",L),(i=document.getElementById("sort-products"))==null||i.addEventListener("change",()=>{B=!0,E()}),(d=document.getElementById("search"))==null||d.addEventListener("input",v),(l=document.getElementById("category-filter"))==null||l.addEventListener("change",v);let n=document.getElementById("faq-btn"),t=document.getElementById("faq-overlay"),e=document.getElementById("faq-close");n&&t&&e&&(n.addEventListener("click",()=>{t.classList.remove("hidden"),e.focus()}),e.addEventListener("click",()=>{t.classList.add("hidden"),n.focus()}),t.addEventListener("click",c=>{c.target===t&&(t.classList.add("hidden"),n.focus())}),document.addEventListener("keydown",c=>{!t.classList.contains("hidden")&&(c.key==="Escape"||c.key==="Esc")&&(t.classList.add("hidden"),n.focus())}));let o=document.getElementById("logoutBtn");o&&o.addEventListener("click",()=>{fetch("/api/logout",{method:"POST",credentials:"include"}).finally(()=>{sessionStorage.clear(),window.location.href="/index.html"})});let s;function r(){clearTimeout(s),s=setTimeout(()=>{alert("Session abgelaufen. Du wirst abgemeldet."),fetch("/api/logout",{method:"POST",credentials:"include"}).finally(()=>{sessionStorage.clear(),window.location.href="/index.html"})},1200*1e3)}["click","keydown","mousemove","touchstart"].forEach(c=>{window.addEventListener(c,r)}),r()});})();
