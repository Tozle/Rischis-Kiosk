(()=>{function p(){let e=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",e?"true":"false")}localStorage.getItem("darkMode")!=="false"&&document.documentElement.classList.add("dark");document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("darkmode-toggle-btn");e&&e.addEventListener("click",p)});var d=window.location.origin,g=new Audio("buzz.wav"),l=null;async function r(){try{return(await(await fetch(`${d}/api/csrf-token`,{credentials:"include"})).json()).csrfToken}catch(e){return null}}localStorage.getItem("darkMode")!=="false"&&document.documentElement.classList.add("dark");async function h(e=6){try{let n=await fetch(`${d}/api/user`,{credentials:"include"});if(!n.ok){if(e>0)return await new Promise(t=>setTimeout(t,500)),h(e-1);throw new Error("not auth")}return await n.json()}catch(n){return e>0&&n.name!=="AbortError"?(await new Promise(a=>setTimeout(a,500)),h(e-1)):(window.location.href="index.html",null)}}async function f(){let e=await fetch(`${d}/api/buzzer/round`,{credentials:"include"}),n=null;if(e.status!==404){if(!e.ok)return;n=(await e.json()).round}let a=document.getElementById("round-info"),t=document.getElementById("join-btn"),o=document.getElementById("end-round-btn"),i=document.getElementById("lock-round-btn"),s=document.getElementById("kolo-controls"),c=document.getElementById("round-form");n?(a.textContent=`Einsatz: ${n.bet} \u20AC, Limit: ${n.points_limit}`,n.joinable===!1?(t.classList.add("hidden"),i==null||i.classList.add("hidden")):(t.classList.remove("hidden"),(l==null?void 0:l.role)==="admin"&&(i==null||i.classList.remove("hidden"))),(l==null?void 0:l.role)==="admin"&&(o==null||o.classList.remove("hidden"),s==null||s.classList.remove("hidden"),c==null||c.classList.add("hidden"))):(a.textContent="Keine laufende Runde",t.classList.add("hidden"),o==null||o.classList.add("hidden"),i==null||i.classList.add("hidden"),s==null||s.classList.add("hidden"),(l==null?void 0:l.role)==="admin"&&(c==null||c.classList.remove("hidden")))}async function m(){let e=await fetch(`${d}/api/buzzer/kolo`,{credentials:"include"}),n=null,a=0;if(e.status!==404){if(!e.ok)return;let o=await e.json();n=o.kolo,a=o.number}let t=document.getElementById("kolo-info");n&&n.active?t.textContent=`Aktives KOLO #${a}`:t.textContent="Warte auf neues KOLO\u2026"}async function u(){let e=await fetch(`${d}/api/buzzer/participants`,{credentials:"include"});if(!e.ok){document.getElementById("participant-list").innerHTML="";return}let{participants:n}=await e.json(),a=document.getElementById("participant-list");a.innerHTML="",n.forEach(t=>{var i;let o=document.createElement("li");o.textContent=((i=t.users)==null?void 0:i.name)||t.username||t.user_id,a.appendChild(o)})}async function E(){let[e,n]=await Promise.all([fetch(`${d}/api/buzzer/sessions`,{credentials:"include"}),fetch(`${d}/api/buzzer/leaderboard`,{credentials:"include"})]),a=document.getElementById("general-info");if(a.innerHTML="",n.ok){let{leaderboard:t}=await n.json();if(t.length>0){let o=document.createElement("ul");t.forEach(i=>{var c;let s=document.createElement("li");s.textContent=`${((c=i.users)==null?void 0:c.name)||i.user_id}: ${i.score} Punkte`,o.appendChild(s)}),a.appendChild(o)}}if(e.ok){let{sessions:t}=await e.json();t==null||t.forEach(o=>{var c;let i=document.createElement("div"),s=((c=o.users)==null?void 0:c.role)==="admin"?"text-red-600":"text-green-600";i.innerHTML=`<span class="${s}">${o.username}</span> \u2013 ${o.online?"online":"offline"}`,a.appendChild(i)})}}async function b(){var a,t,o,i,s,c;let e=await h();if(!e)return;l=e,e.role==="admin"&&(document.getElementById("admin-section").classList.remove("hidden"),(a=document.getElementById("round-form"))==null||a.addEventListener("submit",L),(t=document.getElementById("end-round-btn"))==null||t.addEventListener("click",C),(o=document.getElementById("lock-round-btn"))==null||o.addEventListener("click",w),(i=document.getElementById("start-kolo-btn"))==null||i.addEventListener("click",v),(s=document.getElementById("kolo-correct-btn"))==null||s.addEventListener("click",()=>k(!0)),(c=document.getElementById("kolo-wrong-btn"))==null||c.addEventListener("click",()=>k(!1))),await f(),await u(),await E(),await m();let n=new EventSource(`${d}/api/buzzer/events`,{withCredentials:!0});n.addEventListener("buzz",()=>{g.currentTime=0,g.play().catch(()=>{})}),n.addEventListener("unlock",()=>{document.getElementById("buzz-btn").disabled=!1,document.getElementById("skip-btn").disabled=!1,m()}),n.addEventListener("lock",()=>{document.getElementById("buzz-btn").disabled=!0,document.getElementById("skip-btn").disabled=!0}),document.getElementById("join-btn").addEventListener("click",y),document.getElementById("buzz-btn").addEventListener("click",z),document.getElementById("skip-btn").addEventListener("click",I),setInterval(u,5e3),setInterval(E,5e3),setInterval(f,5e3),setInterval(m,5e3),typeof startSessionCheck=="function"&&startSessionCheck()}document.addEventListener("DOMContentLoaded",b);async function y(){let e=await r(),n=await fetch(`${d}/api/buzzer/join`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","x-csrf-token":e}}),a=document.getElementById("join-message");if(n.ok)document.getElementById("join-btn").disabled=!0,a.textContent="Beigetreten",await u();else{let t=await n.json().catch(()=>({}));a.textContent=t.error||"Fehler beim Beitreten"}setTimeout(()=>{a.textContent=""},3e3)}async function w(e){e.preventDefault();let n=await r(),a=await fetch(`${d}/api/buzzer/round/lock`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","x-csrf-token":n}}),t=document.getElementById("admin-message");if(a.ok)t.textContent="Runde geschlossen",await f();else{let o=await a.json().catch(()=>({}));t.textContent=o.error||"Fehler beim Schliessen"}setTimeout(()=>{t.textContent=""},3e3)}async function z(){let e=await r();(await fetch(`${d}/api/buzzer/buzz`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","x-csrf-token":e}})).ok&&(document.getElementById("buzz-btn").disabled=!0)}async function I(){let e=await r();(await fetch(`${d}/api/buzzer/skip`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","x-csrf-token":e}})).ok&&(document.getElementById("skip-btn").disabled=!0)}async function L(e){e.preventDefault();let n=parseInt(document.getElementById("round-bet").value,10),a=parseInt(document.getElementById("round-limit").value,10),t=await r(),o=await fetch(`${d}/api/buzzer/round`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","x-csrf-token":t},body:JSON.stringify({bet:n,points_limit:a})}),i=document.getElementById("admin-message");if(o.ok)i.textContent="Runde gestartet",await f(),await u();else{let s=await o.json().catch(()=>({}));i.textContent=s.error||"Fehler beim Start",s.detail&&(i.textContent+=`: ${s.detail}`)}setTimeout(()=>{i.textContent=""},3e3)}async function C(e){e.preventDefault();let n=await r(),a=await fetch(`${d}/api/buzzer/round/end`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","x-csrf-token":n}}),t=document.getElementById("admin-message");if(a.ok)t.textContent="Runde beendet",await f(),await u();else{let o=await a.json().catch(()=>({}));t.textContent=o.error||"Fehler beim Beenden"}setTimeout(()=>{t.textContent=""},3e3)}async function v(e){e.preventDefault();let n=await r(),a=await fetch(`${d}/api/buzzer/kolo`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","x-csrf-token":n}}),t=document.getElementById("admin-message");if(a.ok)t.textContent="KOLO gestartet",await m();else{let o=await a.json().catch(()=>({}));t.textContent=o.error||"Fehler beim Starten"}setTimeout(()=>{t.textContent=""},3e3)}async function k(e){let n=await r(),a=await fetch(`${d}/api/buzzer/kolo/end`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","x-csrf-token":n},body:JSON.stringify({correct:e})}),t=document.getElementById("admin-message");if(a.ok)t.textContent="KOLO beendet",await u(),await E(),await m();else{let o=await a.json().catch(()=>({}));t.textContent=o.error||"Fehler beim Beenden"}setTimeout(()=>{t.textContent=""},3e3)}})();
