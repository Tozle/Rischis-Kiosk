(()=>{var r=n=>document.getElementById(n);async function h(){try{return(await(await fetch(`${window.location.origin}/api/csrf-token`,{credentials:"include"})).json()).csrfToken}catch(n){return console.error("CSRF-Token konnte nicht geladen werden",n),null}}function y(n,a=!1){let i=document.getElementById("message");i&&(i.textContent=n,i.className=a?"text-green-600 mt-4 text-center":"text-red-500 mt-4 text-center",i.classList.remove("hidden"),setTimeout(()=>i.classList.add("hidden"),5e3))}var b=window.location.origin;function x(n){let a=n==="login";r("login-form").classList.toggle("hidden",!a),r("register-form").classList.toggle("hidden",a),r("message").classList.add("hidden")}var v=r("show-register-link");v&&v.addEventListener("click",n=>{n.preventDefault(),x("register")});var L=r("show-login-link");L&&L.addEventListener("click",n=>{n.preventDefault(),x("login")});var w=r("register-form");if(w){let n=function(a){let i=["Willkommen zur\xFCck, {name}! \u{1F63A}","Sch\xF6n, dass du wieder da bist, {name}! \u{1F389}","Bereit f\xFCr Snacks, {name}? \u{1F36B}","M\xF6ge der Kiosk mit dir sein, {name}! \u{1F680}","Let\u2019s Kiosk, {name}! \u{1F60E}","Zeit f\xFCr eine Pause, {name}! \u2615","Du bist der Kiosk-King, {name}! \u{1F451}","Snack-Alarm f\xFCr {name}! \u{1F6CE}\uFE0F","Miau, {name}! \u{1F43E}","Kiosk-Power aktiviert, {name}! \u26A1"],o=a;typeof o=="string"?o=o.charAt(0).toUpperCase()+o.slice(1):o="Gast";let d=i[Math.floor(Math.random()*i.length)].replace("{name}",o),e=document.createElement("div");e.id="login-greeting-overlay",e.style.position="fixed",e.style.inset="0",e.style.background="rgba(16,185,129,0.95)",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="9999",e.style.transition="opacity 0.5s",e.style.opacity="0",e.innerHTML=`
    <div style="background:rgba(255,255,255,0.95);color:#134e4a;padding:2.5rem 2rem 2rem 2rem;border-radius:2rem;box-shadow:0 8px 32px 0 rgba(16,185,129,0.18);font-size:2rem;font-weight:700;display:flex;flex-direction:column;align-items:center;gap:1.2rem;max-width:90vw;text-align:center;animation:bounceIn 0.7s;">
      <span style="font-size:2.5rem;">\u{1F388}</span>
      <span>${d}</span>
    </div>
    <style>
      @keyframes bounceIn {
        0% { transform: scale(0.7); opacity: 0; }
        60% { transform: scale(1.1); opacity: 1; }
        80% { transform: scale(0.95); }
        100% { transform: scale(1); opacity: 1; }
      }
    </style>
  `,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="1"},10),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e.remove(),window.location.href="dashboard.html"},500)},1700)};w.addEventListener("submit",async a=>{a.preventDefault();let i=r("register-name").value.trim(),o=r("register-email").value.trim(),d=r("register-password").value,e=r("register-password-repeat").value,l=w.querySelector('button[type="submit"]'),m=r("register-btn-text"),c=r("register-loader");if(l.setAttribute("aria-busy","true"),l.disabled=!0,m.classList.add("opacity-50"),c.classList.remove("hidden"),!i||!o){m.classList.remove("opacity-50"),c.classList.add("hidden");return}if(!d||d.length<6){y("Das Passwort muss mindestens 6 Zeichen lang sein."),l.removeAttribute("aria-busy"),l.disabled=!1,m.classList.remove("opacity-50"),c.classList.add("hidden");return}if(d!==e){y("Passw\xF6rter stimmen nicht \xFCberein."),l.removeAttribute("aria-busy"),l.disabled=!1,m.classList.remove("opacity-50"),c.classList.add("hidden");return}try{let g=await h(),s=await fetch(`${b}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":g},credentials:"include",body:JSON.stringify({name:i,email:o,password:d})}),f=await s.json();if(!s.ok)throw new Error(f.error||"Registrierung fehlgeschlagen");let t=document.createElement("div");t.id="register-success-overlay",t.style.position="fixed",t.style.inset="0",t.style.background="rgba(16,185,129,0.95)",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="9999",t.style.transition="opacity 0.5s",t.style.opacity="0",t.innerHTML=`
        <div style="background:rgba(255,255,255,0.95);color:#134e4a;padding:2.5rem 2rem 2rem 2rem;border-radius:2rem;box-shadow:0 8px 32px 0 rgba(16,185,129,0.18);font-size:2rem;font-weight:700;display:flex;flex-direction:column;align-items:center;gap:1.2rem;max-width:90vw;text-align:center;animation:bounceIn 0.7s;">
          <span style="font-size:2.5rem;">\u{1F389}</span>
          <span>Registrierung erfolgreich!<br><span style='font-size:1.1rem;font-weight:400;'>Du kannst dich jetzt einloggen.</span></span>
        </div>
        <style>
          @keyframes bounceIn {
            0% { transform: scale(0.7); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            80% { transform: scale(0.95); }
            100% { transform: scale(1); opacity: 1; }
          }
        </style>
      `,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1"},10),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{t.remove(),x("login")},500)},1700)}catch(g){console.error(g);let s=g.message||"Fehler bei Registrierung";/name/i.test(s)&&/zeichen|zeichenlang|zeichen lang|zu kurz|mindestens/i.test(s)?s="Bitte gib einen Namen mit mindestens 2 Zeichen an.":/email/i.test(s)&&/ungültig|invalid/i.test(s)?s="Bitte gib eine g\xFCltige E-Mail-Adresse ein.":/passwort|password/i.test(s)&&/ungültig|invalid|mindestens|zu kurz|zeichen/i.test(s)&&(s="Das Passwort muss mindestens 6 Zeichen lang sein."),y(s)}finally{l.removeAttribute("aria-busy"),l.disabled=!1,m.classList.remove("opacity-50"),c.classList.add("hidden")}}),document.getElementById("login-form").addEventListener("submit",async a=>{a.preventDefault();let i=document.getElementById("login-email").value.trim(),o=document.getElementById("login-password").value,d=document.getElementById("remember-me").checked,e=document.querySelector('#login-form button[type="submit"]'),l=document.getElementById("login-btn-text"),m=document.getElementById("login-loader");e.setAttribute("aria-busy","true"),e.disabled=!0,l.classList.add("opacity-50"),m.classList.remove("hidden");try{let c=await h(),g=await fetch(`${b}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":c},credentials:"include",body:JSON.stringify({email:i,password:o,rememberMe:d})}),s=await g.json();if(!g.ok)throw new Error(s.error||"Login fehlgeschlagen");sessionStorage.setItem("firstLogin","true");let f=null;for(let t=0;t<10;t++){try{let u=await fetch(`${b}/api/auth/me`,{credentials:"include"}),p=await u.json();if(u.ok&&p.loggedIn&&p.user&&p.user.name){f=p.user.name;break}}catch(u){}await new Promise(u=>setTimeout(u,500))}n(f||i.split("@")[0])}catch(c){console.error(c),y(c.message||"Fehler beim Login")}finally{e.removeAttribute("aria-busy"),e.disabled=!1,l.classList.remove("opacity-50"),m.classList.add("hidden")}})}})();
