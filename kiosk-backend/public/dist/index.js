(()=>{var m=window.location.origin;async function p(){try{return(await(await fetch(`${m}/api/csrf-token`,{credentials:"include"})).json()).csrfToken}catch(t){return console.error("CSRF-Token konnte nicht geladen werden",t),null}}function d(t,s=!1){let n=document.getElementById("message");n.textContent=t,n.className=s?"text-green-600 mt-4 text-center":"text-red-500 mt-4 text-center",n.classList.remove("hidden"),setTimeout(()=>n.classList.add("hidden"),5e3)}function g(t){let s=t==="login";document.getElementById("login-form").classList.toggle("hidden",!s),document.getElementById("register-form").classList.toggle("hidden",s),document.getElementById("message").classList.add("hidden")}var f=document.getElementById("show-register-link");f&&f.addEventListener("click",t=>{t.preventDefault(),g("register")});var h=document.getElementById("show-login-link");h&&h.addEventListener("click",t=>{t.preventDefault(),g("login")});document.getElementById("register-form").addEventListener("submit",async t=>{t.preventDefault();let s=document.getElementById("register-name").value.trim(),n=document.getElementById("register-email").value.trim(),i=document.getElementById("register-password").value,e=document.getElementById("register-password-repeat").value;if(i!==e)return d("Passw\xF6rter stimmen nicht \xFCberein.");try{let o=await p(),r=await fetch(`${m}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":o},credentials:"include",body:JSON.stringify({name:s,email:n,password:i})}),l=await r.json();if(!r.ok)throw new Error(l.error||"Registrierung fehlgeschlagen");d("Registrierung erfolgreich! Bitte jetzt einloggen.",!0),g("login")}catch(o){console.error(o),d(o.message||"Fehler bei Registrierung")}});document.getElementById("login-form").addEventListener("submit",async t=>{t.preventDefault();let s=document.getElementById("login-email").value.trim(),n=document.getElementById("login-password").value,i=document.querySelector('#login-form button[type="submit"]'),e=document.getElementById("login-btn-text"),o=document.getElementById("login-loader");i.setAttribute("aria-busy","true"),i.disabled=!0,e.classList.add("opacity-50"),o.classList.remove("hidden");try{let r=await p(),l=await fetch(`${m}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":r},credentials:"include",body:JSON.stringify({email:s,password:n})}),w=await l.json();if(!l.ok)throw new Error(w.error||"Login fehlgeschlagen");sessionStorage.setItem("firstLogin","true");let u=null;for(let y=0;y<10;y++){try{let a=await fetch(`${m}/api/auth/me`,{credentials:"include"}),c=await a.json();if(a.ok&&c.loggedIn&&c.user&&c.user.name){u=c.user.name;break}}catch(a){}await new Promise(a=>setTimeout(a,500))}b(u||s.split("@")[0])}catch(r){console.error(r),d(r.message||"Fehler beim Login")}finally{i.removeAttribute("aria-busy"),i.disabled=!1,e.classList.remove("opacity-50"),o.classList.add("hidden")}});function b(t){let s=["Willkommen zur\xFCck, {name}! \u{1F63A}","Sch\xF6n, dass du wieder da bist, {name}! \u{1F389}","Bereit f\xFCr Snacks, {name}? \u{1F36B}","M\xF6ge der Kiosk mit dir sein, {name}! \u{1F680}","Let\u2019s Kiosk, {name}! \u{1F60E}","Zeit f\xFCr eine Pause, {name}! \u2615","Du bist der Kiosk-King, {name}! \u{1F451}","Snack-Alarm f\xFCr {name}! \u{1F6CE}\uFE0F","Miau, {name}! \u{1F43E}","Kiosk-Power aktiviert, {name}! \u26A1"],n=t;typeof n=="string"?n=n.charAt(0).toUpperCase()+n.slice(1):n="Gast";let i=s[Math.floor(Math.random()*s.length)].replace("{name}",n),e=document.createElement("div");e.id="login-greeting-overlay",e.style.position="fixed",e.style.inset="0",e.style.background="rgba(16,185,129,0.95)",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="9999",e.style.transition="opacity 0.5s",e.style.opacity="0",e.innerHTML=`
    <div style="background:rgba(255,255,255,0.95);color:#134e4a;padding:2.5rem 2rem 2rem 2rem;border-radius:2rem;box-shadow:0 8px 32px 0 rgba(16,185,129,0.18);font-size:2rem;font-weight:700;display:flex;flex-direction:column;align-items:center;gap:1.2rem;max-width:90vw;text-align:center;animation:bounceIn 0.7s;">
      <span style="font-size:2.5rem;">\u{1F388}</span>
      <span>${i}</span>
    </div>
    <style>
      @keyframes bounceIn {
        0% { transform: scale(0.7); opacity: 0; }
        60% { transform: scale(1.1); opacity: 1; }
        80% { transform: scale(0.95); }
        100% { transform: scale(1); opacity: 1; }
      }
    </style>
  `,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="1"},10),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e.remove(),window.location.href="dashboard.html"},500)},1700)}})();
