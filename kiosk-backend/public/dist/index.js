(()=>{var c=window.location.origin;async function u(){try{return(await(await fetch(`${c}/api/csrf-token`,{credentials:"include"})).json()).csrfToken}catch(e){return console.error("CSRF-Token konnte nicht geladen werden",e),null}}function d(e,t=!1){let n=document.getElementById("message");n.textContent=e,n.className=t?"text-green-600 mt-4 text-center":"text-red-500 mt-4 text-center",n.classList.remove("hidden"),setTimeout(()=>n.classList.add("hidden"),5e3)}function l(e){let t=e==="login";document.getElementById("login-form").classList.toggle("hidden",!t),document.getElementById("register-form").classList.toggle("hidden",t),document.getElementById("message").classList.add("hidden")}function y(){let e=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",e?"true":"false")}localStorage.getItem("darkMode")!=="false"&&document.documentElement.classList.add("dark");document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("darkmode-toggle-btn");e&&e.addEventListener("click",y);let t=document.getElementById("show-register-link");t&&t.addEventListener("click",o=>{o.preventDefault(),l("register")});let n=document.getElementById("show-login-link");n&&n.addEventListener("click",o=>{o.preventDefault(),l("login")})});document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();let t=document.getElementById("login-email").value.trim(),n=document.getElementById("login-password").value,o=document.querySelector('#login-form button[type="submit"]'),s=document.getElementById("login-btn-text"),i=document.getElementById("login-loader");o.setAttribute("aria-busy","true"),o.disabled=!0,s.classList.add("opacity-50"),i.classList.remove("hidden");try{let r=await u(),g=await fetch(`${c}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":r},credentials:"include",body:JSON.stringify({email:t,password:n})}),h=await g.json();if(!g.ok)throw new Error(h.error||"Login fehlgeschlagen");d("Login erfolgreich! Weiterleitung...",!0),sessionStorage.setItem("firstLogin","true"),await(async(f=10)=>{for(let m=0;m<f;m++){try{let a=await fetch(`${c}/api/auth/me`,{credentials:"include"}),w=await a.json();if(a.ok&&w.loggedIn){window.location.href="dashboard.html";return}}catch(a){}await new Promise(a=>setTimeout(a,500))}window.location.href="dashboard.html"})()}catch(r){console.error(r),d(r.message||"Fehler beim Login")}finally{o.removeAttribute("aria-busy"),o.disabled=!1,s.classList.remove("opacity-50"),i.classList.add("hidden")}});document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();let t=document.getElementById("register-email").value.trim(),n=document.getElementById("register-password").value,o=document.getElementById("register-password-repeat").value;if(n!==o)return d("Passw\xF6rter stimmen nicht \xFCberein.");try{let s=await u(),i=await fetch(`${c}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json","x-csrf-token":s},credentials:"include",body:JSON.stringify({email:t,password:n})}),r=await i.json();if(!i.ok)throw new Error(r.error||"Registrierung fehlgeschlagen");d("Registrierung erfolgreich! Bitte jetzt einloggen.",!0),l("login")}catch(s){console.error(s),d(s.message||"Fehler bei Registrierung")}});})();
