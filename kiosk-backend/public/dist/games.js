(()=>{var t=m=>document.getElementById(m);function M(m,o="success",d=3e3,v=null){let i=document.getElementById("toast");if(!i)return;i.innerHTML="";let L=document.createElement("span");if(L.textContent=m,i.appendChild(L),v){let g=document.createElement("button");g.textContent="R\xFCckg\xE4ngig",g.className="ml-4 px-3 py-1 rounded bg-white/80 text-green-700 font-bold shadow hover:bg-green-100 transition text-xs",g.onclick=()=>{v(),i.classList.add("opacity-0")},i.appendChild(g)}i.className=`fixed left-1/2 top-6 z-50 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-center text-sm font-semibold transition-opacity duration-300 pointer-events-none ${o==="error"?"bg-red-600":"bg-green-600"} text-white opacity-100`,v||setTimeout(()=>{i.classList.add("opacity-0")},d)}document.addEventListener("DOMContentLoaded",()=>{let m="user_profile",o=sessionStorage.getItem("games_session_id");o||(o=Math.random().toString(36).slice(2),sessionStorage.setItem("games_session_id",o));let d=JSON.parse(localStorage.getItem(m)||"{}");async function v(){if(!d.name||!d.image)try{let s=await(await fetch("/api/auth/me",{credentials:"include"})).json();s!=null&&s.loggedIn&&s.user&&(d={name:s.user.name||"",image:s.user.profile_image_url||""},localStorage.setItem(m,JSON.stringify(d)))}catch(e){}}v().then(()=>{let e=d.name||"Gast-"+o.slice(-4),s=d.image||"https://ui-avatars.com/api/?name="+encodeURIComponent(e);async function p(){try{await fetch("/api/online-users",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:o,page:"games",username:e,profile_image_url:s})})}catch(n){}}async function y(){try{await fetch("/api/online-users",{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:o})})}catch(n){}}async function f(){try{let n=await fetch("/api/online-users?page=games",{credentials:"include"});return n.ok?(await n.json()).users||[]:[]}catch(n){return[]}}async function w(){let E=(await f()).filter((k,J,H)=>H.findIndex(U=>U.session_id===k.session_id)===J),$=t("games-online-count");$&&($.textContent=E.length);let j=t("games-online-list");j&&(E.length?j.innerHTML='<div class="flex flex-wrap gap-4 justify-center">'+E.map(k=>`<div class="flex flex-col items-center">
                            <img src="${k.profile_image_url}" alt="${k.username}" class="w-12 h-12 rounded-full border border-gray-300 object-cover mb-1" style="background:#eee;" />
                            <span class="text-xs font-medium">${k.username}</span>
                        </div>`).join("")+"</div>":j.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 py-4">
                        <svg xmlns='http://www.w3.org/2000/svg' class='w-10 h-10 mx-auto mb-2 text-cyan-200' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.75 17L6 21h12l-3.75-4M12 3v14' /></svg>
                        <div class="font-semibold">Noch keine Spieler online.</div>
                    </div>`)}p(),w();let T=setInterval(()=>{p(),w()},1e4);window.addEventListener("beforeunload",()=>{y(),clearInterval(T)}),window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&y(),document.visibilityState==="visible"&&(p(),w())});let l=t("create-lobby-btn"),c=t("lobby-modal"),C=t("lobby-modal-close"),N=t("lobby-form");l&&c&&C&&(l.addEventListener("click",()=>{c.classList.remove("hidden"),C.focus()}),C.addEventListener("click",()=>{c.classList.add("hidden"),l.focus()}),c.addEventListener("click",n=>{n.target===c&&(c.classList.add("hidden"),l.focus())}),document.addEventListener("keydown",n=>{!c.classList.contains("hidden")&&(n.key==="Escape"||n.key==="Esc")&&(c.classList.add("hidden"),l.focus())})),N&&N.addEventListener("submit",n=>{n.preventDefault(),M("Es sind aktuell noch keine Spiele verf\xFCgbar.","info"),c.classList.add("hidden"),l.focus()});let x=t("games-online-btn"),u=t("games-online-overlay"),O=t("games-online-close");x&&u&&O&&(x.addEventListener("click",()=>{u.classList.remove("hidden"),O.focus()}),O.addEventListener("click",()=>{u.classList.add("hidden"),x.focus()}),u.addEventListener("click",n=>{n.target===u&&(u.classList.add("hidden"),x.focus())}),document.addEventListener("keydown",n=>{!u.classList.contains("hidden")&&(n.key==="Escape"||n.key==="Esc")&&(u.classList.add("hidden"),x.focus())}))});async function i(){try{await fetch("/api/online-users",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:o,page:"games",username:name,profile_image_url:image})})}catch(e){}}async function L(){try{await fetch("/api/online-users",{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:o})})}catch(e){}}async function g(){try{let e=await fetch("/api/online-users?page=games",{credentials:"include"});return e.ok?(await e.json()).users||[]:[]}catch(e){return[]}}async function S(){let s=(await g()).filter((f,w,T)=>T.findIndex(l=>l.session_id===f.session_id)===w),p=t("games-online-count");p&&(p.textContent=s.length);let y=t("games-online-list");y&&(s.length?y.innerHTML='<div class="flex flex-wrap gap-4 justify-center">'+s.map(f=>`<div class="flex flex-col items-center">
                        <img src="${f.profile_image_url}" alt="${f.username}" class="w-12 h-12 rounded-full border border-gray-300 object-cover mb-1" style="background:#eee;" />
                        <span class="text-xs font-medium">${f.username}</span>
                    </div>`).join("")+"</div>":y.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 py-4">
                    <svg xmlns='http://www.w3.org/2000/svg' class='w-10 h-10 mx-auto mb-2 text-cyan-200' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.75 17L6 21h12l-3.75-4M12 3v14' /></svg>
                    <div class="font-semibold">Noch keine Spieler online.</div>
                </div>`)}i(),S();let D=setInterval(()=>{i(),S()},1e4);window.addEventListener("beforeunload",()=>{L(),clearInterval(D)}),window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&L(),document.visibilityState==="visible"&&(i(),S())});let h=t("create-lobby-btn"),a=t("lobby-modal"),_=t("lobby-modal-close"),B=t("lobby-form");h&&a&&_&&(h.addEventListener("click",()=>{a.classList.remove("hidden"),_.focus()}),_.addEventListener("click",()=>{a.classList.add("hidden"),h.focus()}),a.addEventListener("click",e=>{e.target===a&&(a.classList.add("hidden"),h.focus())}),document.addEventListener("keydown",e=>{!a.classList.contains("hidden")&&(e.key==="Escape"||e.key==="Esc")&&(a.classList.add("hidden"),h.focus())})),B&&B.addEventListener("submit",e=>{e.preventDefault(),M("Es sind aktuell noch keine Spiele verf\xFCgbar.","info"),a.classList.add("hidden"),h.focus()});let b=t("games-online-btn"),r=t("games-online-overlay"),I=t("games-online-close");b&&r&&I&&(b.addEventListener("click",()=>{r.classList.remove("hidden"),I.focus()}),I.addEventListener("click",()=>{r.classList.add("hidden"),b.focus()}),r.addEventListener("click",e=>{e.target===r&&(r.classList.add("hidden"),b.focus())}),document.addEventListener("keydown",e=>{!r.classList.contains("hidden")&&(e.key==="Escape"||e.key==="Esc")&&(r.classList.add("hidden"),b.focus())}))});})();
