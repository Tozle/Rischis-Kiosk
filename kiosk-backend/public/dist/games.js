(()=>{var n=p=>document.getElementById(p);function c(p,l="success",u=3e3,E=null){let d=document.getElementById("toast");if(!d)return;d.innerHTML="";let S=document.createElement("span");if(S.textContent=p,d.appendChild(S),E){let v=document.createElement("button");v.textContent="R\xFCckg\xE4ngig",v.className="ml-4 px-3 py-1 rounded bg-white/80 text-green-700 font-bold shadow hover:bg-green-100 transition text-xs",v.onclick=()=>{E(),d.classList.add("opacity-0")},d.appendChild(v)}d.className=`fixed left-1/2 top-6 z-50 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-center text-sm font-semibold transition-opacity duration-300 pointer-events-none ${l==="error"?"bg-red-600":"bg-green-600"} text-white opacity-100`,E||setTimeout(()=>{d.classList.add("opacity-0")},u)}document.addEventListener("DOMContentLoaded",()=>{let p="user_profile",l=sessionStorage.getItem("games_session_id");l||(l=Math.random().toString(36).slice(2),sessionStorage.setItem("games_session_id",l));let u=JSON.parse(localStorage.getItem(p)||"{}");async function E(){if(!u.name||!u.image)try{let o=await(await fetch("/api/auth/me",{credentials:"include"})).json();o!=null&&o.loggedIn&&o.user&&(u={name:o.user.name||"",image:o.user.profile_image_url||""},localStorage.setItem(p,JSON.stringify(u)))}catch(e){}}E().then(()=>{let e=u.name||"Gast-"+l.slice(-4),o=u.image||"https://ui-avatars.com/api/?name="+encodeURIComponent(e);async function L(){try{await fetch("/api/online-users",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:l,page:"games",username:e,profile_image_url:o})})}catch(t){}}async function w(){try{await fetch("/api/online-users",{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:l})})}catch(t){}}async function h(){try{let t=await fetch("/api/online-users?page=games",{credentials:"include"});return t.ok?(await t.json()).users||[]:[]}catch(t){return[]}}async function _(){let r=(await h()).filter((i,k,P)=>P.findIndex(z=>z.session_id===i.session_id)===k),s=n("games-online-count");s&&(s.textContent=r.length);let a=n("games-online-list");a&&(r.length?a.innerHTML='<div class="flex flex-wrap gap-4 justify-center">'+r.map(i=>`<div class="flex flex-col items-center">
                            <img src="${i.profile_image_url}" alt="${i.username}" class="w-12 h-12 rounded-full border border-gray-300 object-cover mb-1" style="background:#eee;" />
                            <span class="text-xs font-medium">${i.username}</span>
                        </div>`).join("")+"</div>":a.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 py-4">
                        <svg xmlns='http://www.w3.org/2000/svg' class='w-10 h-10 mx-auto mb-2 text-cyan-200' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.75 17L6 21h12l-3.75-4M12 3v14' /></svg>
                        <div class="font-semibold">Noch keine Spieler online.</div>
                    </div>`)}L(),_();let M=setInterval(()=>{L(),_()},1e4);window.addEventListener("beforeunload",()=>{w(),clearInterval(M)}),window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&w(),document.visibilityState==="visible"&&(L(),_())});let b=n("create-lobby-btn"),f=n("lobby-modal"),N=n("lobby-modal-close"),$=n("lobby-form");b&&f&&N&&(b.addEventListener("click",()=>{f.classList.remove("hidden"),N.focus()}),N.addEventListener("click",()=>{f.classList.add("hidden"),b.focus()}),f.addEventListener("click",t=>{t.target===f&&(f.classList.add("hidden"),b.focus())}),document.addEventListener("keydown",t=>{!f.classList.contains("hidden")&&(t.key==="Escape"||t.key==="Esc")&&(f.classList.add("hidden"),b.focus())}));let T=n("lobby-list"),U=n("game-select");$&&T&&$.addEventListener("submit",async t=>{t.preventDefault();let r=parseInt($.lobby_size.value,10),s=parseFloat($.lobby_bet.value);try{let a=await fetch("/api/games/lobby",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({lobbySize:r,bet:s})}),i=await a.json();a.ok&&i.lobbyId?(c("Lobby erstellt!"),f.classList.add("hidden"),b.focus(),await F()):c(i.error||"Fehler beim Erstellen","error")}catch(a){c("Fehler beim Erstellen","error")}});async function F(){try{let r=await(await fetch("/api/games/lobby",{credentials:"include"})).json();Array.isArray(r.lobbies)&&r.lobbies.length?T.innerHTML=r.lobbies.map(s=>`
                        <div class="bg-cyan-50 dark:bg-gray-800 rounded-xl p-4 flex flex-col md:flex-row md:items-center justify-between gap-4 shadow">
                            <div>
                                <div class="font-bold text-cyan-700 dark:text-cyan-300 text-lg flex items-center gap-2">
                                    Lobby #${s.id.slice(-4)}
                                    <span class="ml-2 text-xs font-normal text-gray-500">${s.players.length}/${s.lobbySize} Spieler</span>
                                </div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">Einsatz: <span class="font-semibold">\u20AC${s.bet.toFixed(2)}</span></div>
                                <div class="flex gap-2 mt-2">
                                    ${s.players.map(a=>`<img src="${a.profile_image_url}" alt="${a.name}" class="w-8 h-8 rounded-full border" title="${a.name}" />`).join("")}
                                </div>
                            </div>
                            <div class="flex gap-2 items-center">
                                <button class="join-lobby-btn btn-main" data-id="${s.id}">Beitreten</button>
                                ${s.players.length>=2&&!s.started?`<button class="start-lobby-btn btn-main bg-green-600 hover:bg-green-700" data-id="${s.id}">Starten</button>`:""}
                            </div>
                        </div>
                    `).join(""):T.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <svg xmlns='http://www.w3.org/2000/svg' class='w-12 h-12 mx-auto mb-2 text-cyan-200' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.75 17L6 21h12l-3.75-4M12 3v14' /></svg>
                        <div class="font-semibold">Noch keine Lobbys vorhanden.</div>
                        <div>Erstelle die erste Lobby mit dem Button oben!</div>
                    </div>`}catch(t){T.innerHTML='<div class="text-center text-red-500 py-8">Fehler beim Laden der Lobbys.</div>'}}F(),T.addEventListener("click",async t=>{let r=t.target.closest(".join-lobby-btn"),s=t.target.closest(".start-lobby-btn");if(r){let a=r.dataset.id;try{let i=await fetch(`/api/games/lobby/${a}/join`,{method:"POST",credentials:"include"}),k=await i.json();i.ok?(c("Lobby beigetreten!"),await F()):c(k.error||"Fehler beim Beitreten","error")}catch(i){c("Fehler beim Beitreten","error")}}if(s){let a=s.dataset.id;try{let i=await fetch(`/api/games/lobby/${a}/start`,{method:"POST",credentials:"include"}),k=await i.json();i.ok&&k.gameId?c("Spiel gestartet!"):c(k.error||"Fehler beim Starten","error")}catch(i){c("Fehler beim Starten","error")}}});let I=n("games-online-btn"),y=n("games-online-overlay"),H=n("games-online-close");I&&y&&H&&(I.addEventListener("click",()=>{y.classList.remove("hidden"),H.focus()}),H.addEventListener("click",()=>{y.classList.add("hidden"),I.focus()}),y.addEventListener("click",t=>{t.target===y&&(y.classList.add("hidden"),I.focus())}),document.addEventListener("keydown",t=>{!y.classList.contains("hidden")&&(t.key==="Escape"||t.key==="Esc")&&(y.classList.add("hidden"),I.focus())}))});async function d(){try{await fetch("/api/online-users",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:l,page:"games",username:name,profile_image_url:image})})}catch(e){}}async function S(){try{await fetch("/api/online-users",{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:l})})}catch(e){}}async function v(){try{let e=await fetch("/api/online-users?page=games",{credentials:"include"});return e.ok?(await e.json()).users||[]:[]}catch(e){return[]}}async function O(){let o=(await v()).filter((h,_,M)=>M.findIndex(b=>b.session_id===h.session_id)===_),L=n("games-online-count");L&&(L.textContent=o.length);let w=n("games-online-list");w&&(o.length?w.innerHTML='<div class="flex flex-wrap gap-4 justify-center">'+o.map(h=>`<div class="flex flex-col items-center">
                        <img src="${h.profile_image_url}" alt="${h.username}" class="w-12 h-12 rounded-full border border-gray-300 object-cover mb-1" style="background:#eee;" />
                        <span class="text-xs font-medium">${h.username}</span>
                    </div>`).join("")+"</div>":w.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 py-4">
                    <svg xmlns='http://www.w3.org/2000/svg' class='w-10 h-10 mx-auto mb-2 text-cyan-200' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.75 17L6 21h12l-3.75-4M12 3v14' /></svg>
                    <div class="font-semibold">Noch keine Spieler online.</div>
                </div>`)}d(),O();let J=setInterval(()=>{d(),O()},1e4);window.addEventListener("beforeunload",()=>{S(),clearInterval(J)}),window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&S(),document.visibilityState==="visible"&&(d(),O())});let x=n("create-lobby-btn"),m=n("lobby-modal"),C=n("lobby-modal-close"),D=n("lobby-form");x&&m&&C&&(x.addEventListener("click",()=>{m.classList.remove("hidden"),C.focus()}),C.addEventListener("click",()=>{m.classList.add("hidden"),x.focus()}),m.addEventListener("click",e=>{e.target===m&&(m.classList.add("hidden"),x.focus())}),document.addEventListener("keydown",e=>{!m.classList.contains("hidden")&&(e.key==="Escape"||e.key==="Esc")&&(m.classList.add("hidden"),x.focus())})),D&&D.addEventListener("submit",e=>{e.preventDefault(),c("Es sind aktuell noch keine Spiele verf\xFCgbar.","info"),m.classList.add("hidden"),x.focus()});let j=n("games-online-btn"),g=n("games-online-overlay"),B=n("games-online-close");j&&g&&B&&(j.addEventListener("click",()=>{g.classList.remove("hidden"),B.focus()}),B.addEventListener("click",()=>{g.classList.add("hidden"),j.focus()}),g.addEventListener("click",e=>{e.target===g&&(g.classList.add("hidden"),j.focus())}),document.addEventListener("keydown",e=>{!g.classList.contains("hidden")&&(e.key==="Escape"||e.key==="Esc")&&(g.classList.add("hidden"),j.focus())}))});})();
