(()=>{document.addEventListener("DOMContentLoaded",()=>{let p="user_profile",i=sessionStorage.getItem("games_session_id");i||(i=Math.random().toString(36).slice(2),sessionStorage.setItem("games_session_id",i));let g=JSON.parse(localStorage.getItem(p)||"{}"),y=g.name||"Gast-"+i.slice(-4),E=g.image||"https://ui-avatars.com/api/?name="+encodeURIComponent(y);async function l(){console.log("Sende Heartbeat...");let e=await fetch("/api/online-users",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:i,page:"games",username:y,profile_image_url:E})}),s=await e.text();console.log("Heartbeat Response:",e.status,s)}async function v(){await fetch("/api/online-users",{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({session_id:i})})}async function b(){let e=await fetch("/api/online-users?page=games",{credentials:"include"}),s=await e.text();if(console.log("Fetch Online Users Response:",e.status,s),!e.ok)return[];try{return JSON.parse(s).users||[]}catch(d){return console.error("Fehler beim Parsen der Online-User-Antwort:",d),[]}}async function r(){let s=(await b()).filter((c,k,w)=>w.findIndex(I=>I.session_id===c.session_id)===k),d=document.getElementById("games-online-count");d&&(d.textContent=s.length);let f=document.getElementById("games-online-list");f&&(s.length?f.innerHTML='<div class="flex flex-wrap gap-4 justify-center">'+s.map(c=>`<div class="flex flex-col items-center">
            <img src="${c.profile_image_url}" alt="${c.username}" class="w-12 h-12 rounded-full border border-gray-300 object-cover mb-1" style="background:#eee;" />
            <span class="text-xs font-medium">${c.username}</span>
          </div>`).join("")+"</div>":f.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 py-4">
          <svg xmlns='http://www.w3.org/2000/svg' class='w-10 h-10 mx-auto mb-2 text-cyan-200' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.75 17L6 21h12l-3.75-4M12 3v14' /></svg>
          <div class="font-semibold">Noch keine Spieler online.</div>
        </div>`)}l(),r();let L=setInterval(()=>{l(),r()},1e4);window.addEventListener("beforeunload",()=>{v(),clearInterval(L)}),window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&v(),document.visibilityState==="visible"&&(l(),r())});let o=document.getElementById("create-lobby-btn"),t=document.getElementById("create-lobby-modal"),m=document.getElementById("close-lobby-modal"),h=document.getElementById("create-lobby-form");o&&t&&m&&(o.addEventListener("click",()=>{t.classList.remove("hidden"),m.focus()}),m.addEventListener("click",()=>{t.classList.add("hidden"),o.focus()}),t.addEventListener("click",e=>{e.target===t&&(t.classList.add("hidden"),o.focus())}),document.addEventListener("keydown",e=>{!t.classList.contains("hidden")&&(e.key==="Escape"||e.key==="Esc")&&(t.classList.add("hidden"),o.focus())})),h&&h.addEventListener("submit",e=>{e.preventDefault(),alert("Es sind aktuell noch keine Spiele verf\xFCgbar."),t.classList.add("hidden"),o.focus()});let a=document.getElementById("games-online-btn"),n=document.getElementById("games-online-overlay"),u=document.getElementById("games-online-close");a&&n&&u&&(a.addEventListener("click",()=>{n.classList.remove("hidden"),u.focus()}),u.addEventListener("click",()=>{n.classList.add("hidden"),a.focus()}),n.addEventListener("click",e=>{e.target===n&&(n.classList.add("hidden"),a.focus())}),document.addEventListener("keydown",e=>{!n.classList.contains("hidden")&&(e.key==="Escape"||e.key==="Esc")&&(n.classList.add("hidden"),a.focus())}))});})();
